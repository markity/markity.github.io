<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  
  <title>IM技术架构(1) 外围基建-长连网关 | Markity&#39;s Notes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  
    <meta name="author" content="Markity">
  
  
    <meta name="description" content="im大图
本文聚焦最上面的长连网关。">
  
  <meta name="description" content="im大图 本文聚焦最上面的长连网关。">
<meta property="og:type" content="article">
<meta property="og:title" content="IM技术架构(1) 外围基建-长连网关">
<meta property="og:url" content="http://example.com/2025/04/24/long-link/index.html">
<meta property="og:site_name" content="Markity&#39;s Notes">
<meta property="og:description" content="im大图 本文聚焦最上面的长连网关。">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://blog-image-1257452121.cos.ap-chongqing.myqcloud.com/im-arch.jpg">
<meta property="og:image" content="https://blog-image-1257452121.cos.ap-chongqing.myqcloud.com/rms-show.jpg">
<meta property="og:image" content="https://blog-image-1257452121.cos.ap-chongqing.myqcloud.com/push-img.jpg">
<meta property="og:image" content="https://blog-image-1257452121.cos.ap-chongqing.myqcloud.com/longlink-arch.jpg">
<meta property="og:image" content="https://blog-image-1257452121.cos.ap-chongqing.myqcloud.com/hot-fix-android.jpg">
<meta property="og:image" content="https://blog-image-1257452121.cos.ap-chongqing.myqcloud.com/longlink-arch.jpg">
<meta property="og:image" content="https://blog-image-1257452121.cos.ap-chongqing.myqcloud.com/single-push-order.jpg">
<meta property="og:image" content="https://blog-image-1257452121.cos.ap-chongqing.myqcloud.com/wx-longlink-protocol.png">
<meta property="og:image" content="https://blog-image-1257452121.cos.ap-chongqing.myqcloud.com/baidu-longlink-protocol.png">
<meta property="og:image" content="https://blog-image-1257452121.cos.ap-chongqing.myqcloud.com/protocol-fields.jpg">
<meta property="og:image" content="https://blog-image-1257452121.cos.ap-chongqing.myqcloud.com/tcp-keep-alive-gpt.jpg">
<meta property="og:image" content="https://blog-image-1257452121.cos.ap-chongqing.myqcloud.com/longlink-down-sync.jpg">
<meta property="og:image" content="https://blog-image-1257452121.cos.ap-chongqing.myqcloud.com/tag-ability.png">
<meta property="article:published_time" content="2025-04-24T08:57:55.000Z">
<meta property="article:modified_time" content="2025-05-05T16:15:32.646Z">
<meta property="article:author" content="Markity">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog-image-1257452121.cos.ap-chongqing.myqcloud.com/im-arch.jpg">
  
    <link rel="alternate" href="/atom.xml" title="Markity&#39;s Notes" type="application/atom+xml">
  
  
    <link rel="icon" type="image/x-icon" href="https://blog-image-1257452121.cos.ap-chongqing.myqcloud.com/avatar.jpg">
  
  
<link rel="stylesheet" href="/css/style.css">

  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div class="wrapper">
    <header id="header">
  <div class="title">
    <h1><a href="/">Markity&#39;s Notes</a></h1>
    <p><a href="/"></a></p>
  </div>
  <nav class="nav">
    <ul>
      
        <li><a href="/">Home</a></li>
      
        <li><a href="/archives">Archives</a></li>
      
      
        <li><a href="/atom.xml">RSS</a></li>
      
    </ul>
    <div class="clearfix"></div>
  </nav>
  <div class="clearfix"></div>
</header>
    <div class="content"><article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2025/04/24/long-link/">
  <time datetime="2025-04-24T08:57:55.000Z">
    2025-04-24
  </time>
</a>
    
    
  
    <h1 class="title">IM技术架构(1) 外围基建-长连网关</h1>
  

  </header>
  
  <div class="entry">
    
      <h1 id="im大图"><a href="#im大图" class="headerlink" title="im大图"></a>im大图</h1><p><img src="https://blog-image-1257452121.cos.ap-chongqing.myqcloud.com/im-arch.jpg" alt="im系统上下游"></p>
<p>本文聚焦最上面的长连网关。</p>
<span id="more"></span>

<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>长连是客户端和服务端进行通讯的双工通道，多业务可基于长连接进行数据上下行的实时收发</p>
<p>本文剖析长连网关能力。在目前的所有app中长连网关是一个“中台能力”, 不同业务可以复用同一条长连接, 可以实现非常多功能，包括但不限于: </p>
<ul>
<li>聊天业务的站内push：例如一个新的im消息到来，需要推送给手机端显示，让客户端感知到新消息<!--more--></li>
<li>踢人下线推送：多设备管理可以踢出另外一个用户，此时可以invalidate另外一些设备的token，并且做长连kick操作，让客户端”主动下线”（token失效+长连断开）</li>
<li>消息红点的站内push：xhs会有消息红点服务，也就是消息服务，这里消息红点的维护实际上也是推拉结合，msg_detect接口定时纠偏，然后长连站内push实时增加红点计数</li>
<li>直播间聊天: 实际上大家进入直播间后，还可以在聊天室里面刷礼物聊天，可以接入长连，这个可以接入长连room能力(本文没有提到)</li>
<li>客服IM：电商单独接入，自己做ai agent或者座席聊天，可以复用长连中台能力</li>
<li>app热修fix: 让客户端下载热修patch包修复线上问题</li>
<li>ai chatbot: ai聊天实时推送，如chatgpt可以选用sse，但是也可以接入app的通用长连</li>
</ul>
<blockquote>
<p>中台能力&#x2F;中台化：中台能力实际上指的是”通用能力”，我们搭建一个中台系统，大伙都可以接入。例如在小红书，会有评论中台，地图点位评论和书影音评论都可以以较低的成本接入中台，迅速提供评论能力。</p>
<p>显然长连接系统也是可以“中台化”的，一条长连接，提供给不同业务域使用。</p>
</blockquote>
<p><img src="https://blog-image-1257452121.cos.ap-chongqing.myqcloud.com/rms-show.jpg" alt="消息系统"></p>
<blockquote>
<p>站外push&#x2F;站内push?</p>
<p>站外push：走的运营商厂商push(不同的机型&#x2F;品牌一一适配): 给定device fingerprint，然后推送指定内容。app可以注册一个回调，即使app被挂起也能显示出这样的推送物料，作为长连网关，我们不感知站外push，站外push可以由别的团队支持和维护，对于业务方，发一个mq即可。<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/543682793#:~:text=%E9%A1%BE%E5%90%8D%E6%80%9D%E4%B9%89%EF%BC%8C%E5%8E%82%E5%95%86%E9%80%9A%E9%81%93%E5%B0%B1%E6%98%AF%E6%8C%87%E6%89%8B%E6%9C%BA%E7%A1%AC%E4%BB%B6%E5%8E%82%E5%95%86%E6%8F%90%E4%BE%9B%E7%9A%84%E7%B3%BB%E7%BB%9F%E7%BA%A7%E5%88%AB%E7%9A%84%E6%8E%A8%E9%80%81%E9%80%9A%E9%81%93%EF%BC%8C%E5%9B%A0%E4%B8%BA%E6%98%AF%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1%EF%BC%8C%E9%9A%8F%E7%9D%80%E8%AE%BE%E5%A4%87%E5%BC%80%E6%9C%BA%E5%90%8E%E5%B0%B1%E4%B8%80%E7%9B%B4%E5%AD%98%E5%9C%A8%E7%9D%80%EF%BC%8C%E6%9C%89%E6%95%88%E7%9A%84%E4%BF%9D%E8%AF%81%E4%BA%86%E6%8E%A8%E9%80%81%E9%80%9A%E9%81%93%E9%95%BF%E8%BF%9E%E6%8E%A5%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8%E6%80%A7%E3%80%82,%E5%9C%A8%E6%B5%B7%E5%A4%96%EF%BC%8C%E7%94%B1%E4%BA%8E%E5%AE%89%E5%8D%93%E7%B3%BB%E7%BB%9F%E9%BB%98%E8%AE%A4%E6%94%AF%E6%8C%81%E8%B0%B7%E6%AD%8CFCM%E9%80%9A%E9%81%93%EF%BC%8C%E4%B8%94%E7%BD%91%E7%BB%9C%E7%8E%AF%E5%A2%83%E4%B8%8D%E5%8F%97%E5%9C%B0%E5%9F%9F%E9%99%90%E5%88%B6%EF%BC%8C%E5%9B%A0%E6%AD%A4%E5%8E%82%E5%95%86%E6%9C%AA%E5%AF%B9%E5%87%BA%E5%8F%A3%E6%B5%B7%E5%A4%96%E7%89%88%E7%9A%84%E6%89%8B%E6%9C%BA%E8%BF%9B%E8%A1%8CGMS%E7%9A%84%E9%98%89%E5%89%B2%EF%BC%8C%E8%80%8C%E6%98%AF%E4%BF%9D%E7%95%99%E5%8E%82%E5%95%86%E9%80%9A%E9%81%93%E4%B8%8E%E8%B0%B7%E6%AD%8CFCM%E9%80%9A%E9%81%93%E5%85%B1%E5%AD%98%E7%9A%84%E6%96%B9%E5%BC%8F%E3%80%82">点击此处查看介绍</a>。</p>
<p>站内push: 也就是长连下行，可以简单理解为，向某个设备的长连接发消息即可。<br><img src="https://blog-image-1257452121.cos.ap-chongqing.myqcloud.com/push-img.jpg" alt="站外push"></p>
</blockquote>
<h1 id="长连的通用能力"><a href="#长连的通用能力" class="headerlink" title="长连的通用能力"></a>长连的通用能力</h1><p>长连通用能力:</p>
<ul>
<li>基本的建立长连接，维护设备状态: 维护设备状态: offline(建立连但未登录态)&#x2F;online(登录态)&#x2F;background(后台挂起态)<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">客户端发起连接 -&gt; sdk选长连网关ipport，建立tcp连接 -&gt; 登录信令进行登录</span><br></pre></td></tr></table></figure></li>
<li>查询在线设备信息: 可以按用户维度查询在线状态</li>
<li>客户端上行: 带业务方ack的, 或者不带业务方ack的</li>
<li>不可靠下行: 不可靠推送, 如果uid&#x2F;device_id在线，直接推，反之直接丢弃</li>
<li>可靠下行: 无论uid&#x2F;device_id是否存在，都存储下推数据，用户连接存在下推后等待，直到端侧ACK到达后，删除基于端的下推数据；若用户连接不存在，等用户在线后拉取增量数据, 做消息ack</li>
</ul>
<p>可靠推送要先定序，然后存储，再下行，客户端收到gap后直接拉齐消息（可能客户端侧会3s定时检测连续，然后拉空洞）。定seq可以用redis做。</p>
<ul>
<li>保序推送&#x2F;非保序请求: 客户端收到的下行消息的顺序和服务端收到的上行消息顺序是否一致</li>
</ul>
<p>目前比较常见的系统，上行网关调用业务是异步的，所以客户端要接受这样的事实：向长连连续发两个data packet 1和2，data packet2先被处理。或者data packet2先被处理，但是ack1却先到达客户端。</p>
<blockquote>
<p>保序的必要性?</p>
<p>先讨论几种需求</p>
<ol>
<li>客户端的上行消息需要ack, 但是ack不要求保序(目前我所在公司所用的)<br>  这种情况需要做一个上行网关up router(因为下游阻塞会有用光线程池的风险, 不能在transmission server直接调用下游业务，接入服务风险降低)<br>  这种情况, 最好transmission server调用up router, 投递上行任务, 然后up router向业务投递业务消息, 业务干完了回调up router<br>  这样可以发给up router ack, 然后up router再将ack写回给transmission server, transmission server将消息写回socket给客户端。<br>  <img src="https://blog-image-1257452121.cos.ap-chongqing.myqcloud.com/longlink-arch.jpg" alt="arch"><br>  异步ack的好处是: 下游劣化的风险小, 因为ack都异步了, 不用阻塞rpc等业务回ack。<br>  但是坏处也是有的: 就是客户端连续发req1, req2, 可能req2先被执行, 且ack回复的顺序也是不确定的。im场景, 用户会有感知: 先发消息1, 再发消息2, 可能后续消息2在前(先执行, 先被定序)。</li>
<li>客户端的上行消息需要ack, 但是ack要求保序<br>  这种情况也需要一个上行网关up router, 且需要一致性hash, 将一个uid+deviceId+bizName定位到一个内存队列上, 一个个调用下游业务方, 然后一个个回调给transmission server</li>
<li>客户端的上行消息不需要ack<br>  这种情况给业务方提供一个消息队列, 将一个uid+deviceId+bizName做partition即可<br>  这样ack只能业务方自行发下行rpc了, 想要保序就利用下行网关的顺序下行能力。</li>
</ol>
</blockquote>
<ul>
<li>多端登录&#x2F;踢人能力</li>
</ul>
<blockquote>
<p>能够管理多端设备，kick其它设备，或者能够实现 android&#x2F;ipad&#x2F;电脑 各终端仅能登录一个设备。例如两个android设备登录，实际上后者会让前者被kick掉。</p>
</blockquote>
<ul>
<li><p>uid&#x2F;deviceId单播下行</p>
</li>
<li><p>组播tag能力: 按组播池下行，后面有讨论，常常用于热修</p>
</li>
<li><p>广播: 按domain&#x2F;bizName，给同一个业务域的所有连接通道下推数据</p>
</li>
</ul>
<blockquote>
<p><img src="https://blog-image-1257452121.cos.ap-chongqing.myqcloud.com/hot-fix-android.jpg" alt="站外push"></p>
</blockquote>
<p>网关信令:</p>
<ul>
<li>login: 登录</li>
<li>offline: 断连</li>
<li>ping: 心跳</li>
<li>foregroud: 切换前台模式</li>
<li>background: 切换后台模式</li>
<li>logout: 长连登录态且登出</li>
<li>kickout: 踢出设备</li>
<li>addtag: 加入tag（见本文其它部分的长连tag能力）</li>
<li>remtag: 删除tag</li>
</ul>
<p>业务数据belike:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bizName: chat-im</span><br><span class="line">cmd: send_msg</span><br><span class="line">body: data...</span><br></pre></td></tr></table></figure>

<p>名词解释:</p>
<ul>
<li>上行：消息由端侧发给服务端</li>
<li>下行：消息由服务端发给端侧</li>
<li>信令：也就是命令，分为网关信令，和业务数据，网关信令是网关处理的，业务数据是转发给业务域的</li>
<li>可靠推送: 需要网关侧进行存储，客户端收到了ack手动删除，比如一些推荐朋友，或者app热修信息</li>
<li>不可靠推送: 查完register服务，直接对设备进行下行，不要求客户端回复ack</li>
<li>热修: 针对某个出问题的app包，下发一个带有修复代码&#x2F;资源&#x2F;so的热修包，用户成功加载patch包后，及时生效，就实现了问题修复</li>
</ul>
<h1 id="长连网关的架构"><a href="#长连网关的架构" class="headerlink" title="长连网关的架构"></a>长连网关的架构</h1><ol>
<li>大体架构图</li>
</ol>
<p><img src="https://blog-image-1257452121.cos.ap-chongqing.myqcloud.com/longlink-arch.jpg" alt="arch"></p>
<ul>
<li>tansmission-service: 接长连接的，netty实现的外围服务，解析信令。仅仅作为上下行数据的收发，通道侧</li>
<li>up-router: 上行网关，收到uid_deviceId_bizName维度的mq消费，异步调用，不阻塞，不等待，异步回复ack。</li>
<li>register-service: 登录&#x2F;kick&#x2F;注销&#x2F;在线状态查询相关</li>
<li>sync-server: 下行网关，收到uid_deviceId_bizName维度的mq消费，一个个调用transmission-service进行下行</li>
<li>auth-service: 实际上就是封装了一些鉴权逻辑，这些逻辑丢register-service也合理</li>
</ul>
<blockquote>
<p>下行多mq&#x2F;rpc是为什么: 高低优先级，rpc对时延很敏感。</p>
<p>上行网关的上行做异步: 例如一个长连同时写cmd1 + cmd2，实际上cmd1 和 cmd2的执行先后顺序不能确定。<br>所以此处常见的用户体验问题是这样的: 一个用户先后做发两条消息的动作: 来北京，来上海，实际上最后可能业务放定序会定成 来上海，来北京。业务应该感知到这个异步上行的问题。<br>为什么需要上行网关? 原因是rpc上行，它会调用下游rpc，下游实际上会劣化，可能让线程池被用完，我们希望将这种风险大的东西给到网关做。下游劣化的时候直接扩容网关。<br>当然直接给业务方发uid+deviceId+bizName的mq也是合理的，能保证上行的顺序，但是问题就是不能给到ack，需要业务域自行push下行。</p>
</blockquote>
<ol start="2">
<li>如何顺序上行</li>
</ol>
<p>上面说到router层实际上是异步上行，且异步ack的，那么如何顺序上行呢?</p>
<p>这里提供一个思路，长连网关直接按uid+deviceId+bizName维度找mq partition写入，给到业务方，就能给到业务方顺序的上行了，但是坏处是没法ack回调，这对业务其实是没毛病的，可以让业务方和客户端自行商量，业务方自行下行ack。</p>
<ol start="3">
<li>如何顺序可靠下行</li>
</ol>
<p><img src="https://blog-image-1257452121.cos.ap-chongqing.myqcloud.com/single-push-order.jpg" alt="seq order push"></p>
<p>顺序下行，核心思路是一个sync server消息红点的站内push：<br>a. 所有业务业务按照uid hash，保证相同用户的消息在同一台机器上<br>b. 同意机器上，消息队列按照bizName做内存队列排队<br>c. uid的消息在同意台机器上按顺序推送到端上，端上对受到的消息做连续性检测发现空洞</p>
<ol start="4">
<li>如何可靠推送</li>
</ol>
<p>device&#x2F;或者uid维度的写扩散队列，推拉结合，检测gap主动拉补偿，拉到了客户端手动ack删除。消息下行采用写扩散，seq连续且递增检测空洞，拉齐消息。</p>
<ol start="5">
<li>如何实现req&#x2F;ack保序性: 也就是客户端给req1 + req2，服务端回复是ack1 + ack2</li>
</ol>
<p>前面讨论保序，已经提到了。</p>
<h1 id="长连协议头调研"><a href="#长连协议头调研" class="headerlink" title="长连协议头调研"></a>长连协议头调研</h1><ol>
<li>wx mars长连协议</li>
</ol>
<p><img src="https://blog-image-1257452121.cos.ap-chongqing.myqcloud.com/wx-longlink-protocol.png" alt="wx protocol"></p>
<ol start="2">
<li>百度长连协议</li>
</ol>
<p><img src="https://blog-image-1257452121.cos.ap-chongqing.myqcloud.com/baidu-longlink-protocol.png" alt="baidu protocol"></p>
<h1 id="长连协议选型"><a href="#长连协议选型" class="headerlink" title="长连协议选型"></a>长连协议选型</h1><p><img src="https://blog-image-1257452121.cos.ap-chongqing.myqcloud.com/protocol-fields.jpg" alt="protocol"></p>
<ol>
<li>signal信令</li>
</ol>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">message </span><span class="title class_">SignalFrame</span> &#123;</span><br><span class="line">    <span class="keyword">oneof</span> stream &#123;</span><br><span class="line">        <span class="comment">//请求</span></span><br><span class="line">        SignalStreamData data = <span class="number">100</span>;</span><br><span class="line">        <span class="comment">//响应</span></span><br><span class="line">        AckStreamData ack = <span class="number">101</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 信令请求元数据</span></span><br><span class="line"><span class="comment">// 既有客户端到服务端，也有服务端到客户端</span></span><br><span class="line"><span class="keyword">message </span><span class="title class_">SignalStreamData</span> &#123;</span><br><span class="line">    <span class="comment">// ack模式</span></span><br><span class="line">    AckMode ackMode = <span class="number">1</span>;</span><br><span class="line">     <span class="comment">// 业务操作</span></span><br><span class="line">    <span class="type">string</span> cmd = <span class="number">2</span>;</span><br><span class="line">    <span class="comment">// 信令数据</span></span><br><span class="line">    <span class="type">bytes</span> body = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 响应元数据</span></span><br><span class="line"><span class="keyword">message </span><span class="title class_">AckStreamData</span> &#123;</span><br><span class="line">   <span class="comment">// 0-成功消费  1-没消费</span></span><br><span class="line">    <span class="comment">// 响应时间</span></span><br><span class="line">    <span class="type">int32</span> code = <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 返回状态信息</span></span><br><span class="line">    <span class="type">string</span> message = <span class="number">2</span>;</span><br><span class="line">    <span class="comment">// 返回数据</span></span><br><span class="line">    <span class="type">bytes</span> body = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 响应模式</span></span><br><span class="line"><span class="keyword">enum </span><span class="title class_">AckMode</span> &#123;</span><br><span class="line">  NON_ACK = <span class="number">0</span>;</span><br><span class="line">  ACK_IMMEDIATELY = <span class="number">1</span>;</span><br><span class="line">  ACK_AFTER_RESPONSE = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>data信令</li>
</ol>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">message </span><span class="title class_">DataFrame</span> &#123;</span><br><span class="line">    <span class="keyword">oneof</span> stream &#123;</span><br><span class="line">        <span class="comment">//  请求</span></span><br><span class="line">        CSStreamData data = <span class="number">100</span>;</span><br><span class="line">        <span class="comment">// 响应</span></span><br><span class="line">        AckStreamData ack = <span class="number">101</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// DATA 数据元数据</span></span><br><span class="line"><span class="keyword">message </span><span class="title class_">CSStreamData</span> &#123;</span><br><span class="line">  <span class="comment">// ack模式</span></span><br><span class="line">  AckMode ackMode = <span class="number">1</span>;</span><br><span class="line">  <span class="comment">// 业务操作</span></span><br><span class="line">  <span class="type">string</span> cmd = <span class="number">2</span>;</span><br><span class="line">  <span class="comment">// 业务标识</span></span><br><span class="line">  <span class="type">string</span> bizName = <span class="number">3</span>;</span><br><span class="line">  <span class="comment">// 业务数据</span></span><br><span class="line">  <span class="type">bytes</span> body = <span class="number">4</span>;</span><br><span class="line">  <span class="comment">// 业务透传的扩展信息</span></span><br><span class="line">  map&lt;<span class="type">string</span>，<span class="type">string</span>&gt; extInfo = <span class="number">5</span>;</span><br><span class="line">  <span class="comment">// 上行路由标识</span></span><br><span class="line">  <span class="type">string</span> serviceId = <span class="number">6</span>;</span><br><span class="line">  <span class="comment">// 别名</span></span><br><span class="line">  <span class="comment">// 若不带，则取登录用户;否则，取别名</span></span><br><span class="line">  <span class="type">string</span> alias = <span class="number">7</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>sync信令</li>
</ol>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">message </span><span class="title class_">SyncFrame</span> &#123;</span><br><span class="line">    <span class="keyword">oneof</span> stream &#123;</span><br><span class="line">       <span class="comment">// 请求</span></span><br><span class="line">       SCStreamData data = <span class="number">100</span>;</span><br><span class="line">        <span class="comment">// 响应</span></span><br><span class="line">        AckFrameData ack = <span class="number">101</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// SYNC 同步元数据</span></span><br><span class="line"><span class="keyword">message </span><span class="title class_">SCStreamData</span> &#123;</span><br><span class="line">  <span class="comment">// ack模式</span></span><br><span class="line">  AckMode ackMode = <span class="number">1</span>;</span><br><span class="line">  <span class="comment">// 业务名称，端侧 sdk 路由和打点使用</span></span><br><span class="line">  <span class="type">string</span> bizName = <span class="number">2</span>;</span><br><span class="line">  <span class="comment">// 业务下行数据</span></span><br><span class="line">  Event body = <span class="number">3</span>;</span><br><span class="line">  <span class="comment">// 下推时间</span></span><br><span class="line">  <span class="type">int64</span> time = <span class="number">4</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 下行事件</span></span><br><span class="line"><span class="keyword">message </span><span class="title class_">Event</span> &#123;</span><br><span class="line">  <span class="type">bytes</span> data = <span class="number">1</span>; <span class="comment">// 业务数据</span></span><br><span class="line">  <span class="type">string</span> mid = <span class="number">2</span>; <span class="comment">// 业务消息 id</span></span><br><span class="line">  <span class="type">string</span> cmd = <span class="number">3</span>; </span><br><span class="line">  map&lt;<span class="type">string</span>，<span class="type">string</span>&gt; extInfo = <span class="number">4</span>; <span class="comment">// 业务透传的扩展信息</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="长连实现细节-登录"><a href="#长连实现细节-登录" class="headerlink" title="长连实现细节-登录"></a>长连实现细节-登录</h1><p>登录流程能够看到主要的存储和服务配合:</p>
<p>前面提到的transmission-service实际上是做消息上下行的，不处理设备信息管理，其实它只管理了socket的内存状态。连接状态是register-service那边的redis管理的。transmission-service调用了register的rpc。</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">service </span><span class="title class_">RegisterService</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 心跳</span></span><br><span class="line"><span class="comment">    **/</span></span><br><span class="line">    response.HeartResponse heart(<span class="number">1</span>: <span class="keyword">required</span> base.Context ctx，<span class="number">2</span>: <span class="keyword">required</span> <span class="type">string</span> req);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 登录</span></span><br><span class="line"><span class="comment">    **/</span></span><br><span class="line">    response.LoginResponse login(<span class="number">1</span>: <span class="keyword">required</span> base.Context ctx，<span class="number">2</span>: <span class="keyword">required</span> <span class="type">string</span> req);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 下线</span></span><br><span class="line"><span class="comment">    **/</span></span><br><span class="line">    response.OfflineResponse offline(<span class="number">1</span>: <span class="keyword">required</span> base.Context ctx，<span class="number">2</span>: <span class="keyword">required</span> <span class="type">string</span> req);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 退到后台</span></span><br><span class="line"><span class="comment">    **/</span></span><br><span class="line">    response.BackgroundResponse background(<span class="number">1</span>: <span class="keyword">required</span> base.Context ctx，<span class="number">2</span>: <span class="keyword">required</span> <span class="type">string</span> req);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 进到前台</span></span><br><span class="line"><span class="comment">    **/</span></span><br><span class="line">    response.ForegroundResponse foreground(<span class="number">1</span>: <span class="keyword">required</span> base.Context ctx，<span class="number">2</span>: <span class="keyword">required</span> <span class="type">string</span> req);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 业务绑定</span></span><br><span class="line"><span class="comment">    **/</span></span><br><span class="line">    response.BizRegisterResponse bizRegister(<span class="number">1</span>: <span class="keyword">required</span> base.Context ctx，<span class="number">2</span>: <span class="keyword">required</span> <span class="type">string</span> req);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 进房</span></span><br><span class="line"><span class="comment">    **/</span></span><br><span class="line">    response.JoinResponse join(<span class="number">1</span>: <span class="keyword">required</span> base.Context ctx，<span class="number">2</span>: <span class="keyword">required</span> <span class="type">string</span> req);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 退房</span></span><br><span class="line"><span class="comment">    **/</span></span><br><span class="line">    response.LeaveResponse leave(<span class="number">1</span>: <span class="keyword">required</span> base.Context ctx，<span class="number">2</span>: <span class="keyword">required</span> <span class="type">string</span> req);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 增加标签</span></span><br><span class="line"><span class="comment">    **/</span></span><br><span class="line">    response.AddTagResponse addTag(<span class="number">1</span>: <span class="keyword">required</span> base.Context ctx，<span class="number">2</span>: <span class="keyword">required</span> <span class="type">string</span> req);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 删除标签</span></span><br><span class="line"><span class="comment">    **/</span></span><br><span class="line">    response.RemoveTagResponse removeTag(<span class="number">1</span>: <span class="keyword">required</span> base.Context ctx，<span class="number">2</span>: <span class="keyword">required</span> <span class="type">string</span> req);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * tag心跳</span></span><br><span class="line"><span class="comment">    ***/</span></span><br><span class="line">    response.TagHeartResponse tagHeart(<span class="number">1</span>: <span class="keyword">required</span> base.Context ctx，<span class="number">2</span>: <span class="keyword">required</span> <span class="type">string</span> req);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里简单看看java是如何处理长连信令的: java会使用netty注册信令, java在低版本没有协程，于是使用netty做长连网关，一个比较常见的写法是将包体解析出来然后publishEvent来处理, java是传统reactor epoll框架。</p>
<p>为了稳定性，不能在io事件循环里面做耗时的rpc调用(下游劣化了这个epoll会堵住，一个下游的劣化就能拖跨整个event loop)。所以这里必然用异步回调，但是这样执行命令的顺序性其实很有问题。如果要解决这两个问题(不阻塞eventloop + 顺序性)，可以在内存中做一个uid+deviceId+bizname partition的内存队列, 调用下游服务，调用完后就runInLoop将ack写回。 </p>
<p>go: 一个长连接用一个goroutine处理，调用下游纯用阻塞rpc，下游劣化问题不大，不会阻塞其它连接。</p>
<p>这里继续看看register-service的redis存储，按uid分片:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">type: hash</span><br><span class="line">key: &#123;uid&#125;</span><br><span class="line">field: &#123;socketId:这个是auth服务生成的一个socketId，理解成一个唯一的id就行了&#125;</span><br><span class="line">value: &#123;json化的socket的更多信息，设备/app信息，userStatus，deviceId&#125;</span><br><span class="line">expire: 300s</span><br><span class="line"></span><br><span class="line">key: hash</span><br><span class="line">key: &#123;uid&#125;.&#123;deviceId&#125;</span><br><span class="line">field: &#123;socketId&#125;</span><br><span class="line">value: &#123;json化的socket的更多信息，设备/app信息，userStatus，deviceId&#125;   同上面的value</span><br><span class="line">expire: 300s</span><br></pre></td></tr></table></figure>

<h1 id="长连实现细节-心跳"><a href="#长连实现细节-心跳" class="headerlink" title="长连实现细节-心跳"></a>长连实现细节-心跳</h1><p>实际上发生心跳包的时候直接调用register的heart rpc，此时可以刷新reset上面两个kv的过期时间。实际上任何包，都可以更新心跳，让register重新set这两个kv。</p>
<p>这里可以有一个优化，如果client.lastActiveTimePoint离当前小于50s，就不调用register了，防止频繁写redis。</p>
<p>实际上任何类型的包都会做lastActiveTimePoint的更新以及register heart rpc的调用，heart心跳包只是为了在没有进行交互的情况下“维持连接活性”，续上“连接租约”。</p>
<blockquote>
<p>应用层的心跳是否是必要的? 是的。我这里从tcp和业务两个角度进行阐述:</p>
<ol>
<li>tcp层面: 实际上，现在中国的网络大多是nat，而nat的那个cache是比较短的，可能就十五分钟。此时tcp keepalive的配置也没啥用。<br><img src="https://blog-image-1257452121.cos.ap-chongqing.myqcloud.com/tcp-keep-alive-gpt.jpg" alt="tcp keep alive"></li>
<li>业务上: 假如我们把keep alive的时间设置的很小很小（远小于nat cache过期值），其实也不行。因为tcp正常只能说是协议栈正常，但是不能说应用正常（比如进程死锁了）。且tcp层面的keep alive心跳包没法触发业务逻辑。</li>
</ol>
</blockquote>
<h1 id="长连实现细节-下行"><a href="#长连实现细节-下行" class="headerlink" title="长连实现细节-下行"></a>长连实现细节-下行</h1><p>目前我们register的存储很简单，两个hash见上，存了用户的设备信息，我们可以直接按uid，deviceId下行消息。通常我们可以发mq进行下行，要进行消息下行的业务方可以衡量触达速率，申请不同的mq（消费速率不同，衡量业务方的发送速率，看看部署多少下行网关）。</p>
<p><img src="https://blog-image-1257452121.cos.ap-chongqing.myqcloud.com/longlink-down-sync.jpg" alt="下行"></p>
<h1 id="长连实现细节-tag"><a href="#长连实现细节-tag" class="headerlink" title="长连实现细节-tag"></a>长连实现细节-tag</h1><p>有一些场景，如给订阅某个关注页的人下推数据，给订阅某个设备属性（cpu+builder+xxx）进行热修等等此类场景。只要用户长连连上，然后端上触发了订阅tag，相当于在长连通道上添加了标签属性。</p>
<p>业务方可以按照这个标签属性，给订阅这部分tag的设备下推数据，在register redis存储那边看来，它看起来是一个hash:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">type: hash</span><br><span class="line">key: &#123;bizName&#125;.&#123;tag&#125;</span><br><span class="line">field: ip(这是长连网关的ip)</span><br><span class="line">value: time</span><br><span class="line">expire: 300s</span><br></pre></td></tr></table></figure>

<p>加tag&#x2F;remove tag就是写这个hash。并且长连网关transmission那里也会记录tag信息，使用了下面的结构（下面的信息存储在transmission server）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NamespaceClientBox</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, BaseClient&gt; ALL_CLIENTS = PlatformDependent.newConcurrentHashMap();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;MulticastIdInfo, ConcurrentSkipListSet&lt;BaseClient&gt;&gt; MULTICAST_CLIENTS = PlatformDependent.newConcurrentHashMap();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Map&lt;String, ConcurrentSkipListSet&lt;BaseClient&gt;&gt;&gt; TAG_CLIENTS = PlatformDependent.newConcurrentHashMap();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">NamespaceClientBox</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, BaseClient&gt; <span class="title function_">getClient</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.ALL_CLIENTS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Map&lt;MulticastIdInfo, ConcurrentSkipListSet&lt;BaseClient&gt;&gt; <span class="title function_">getMulticastClient</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.MULTICAST_CLIENTS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, Map&lt;String, ConcurrentSkipListSet&lt;BaseClient&gt;&gt;&gt; <span class="title function_">getAllTagClient</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.TAG_CLIENTS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addTagClient</span><span class="params">(String bizName, String tagId, BaseClient client)</span> &#123;</span><br><span class="line">        client.getTagInfos().computeIfAbsent(bizName, (k) -&gt; <span class="keyword">new</span> <span class="title class_">ArrayList</span>());</span><br><span class="line">        List&lt;String&gt; tagIds = (List)client.getTagInfos().get(bizName);</span><br><span class="line">        <span class="keyword">if</span> (!tagIds.contains(tagId)) &#123;</span><br><span class="line">            ((ConcurrentSkipListSet)((Map)<span class="built_in">this</span>.TAG_CLIENTS.computeIfAbsent(bizName, (k) -&gt; <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>())).computeIfAbsent(tagId, (k) -&gt; <span class="keyword">new</span> <span class="title class_">ConcurrentSkipListSet</span>(Comparator.comparing(BaseClient::getSocketId, String::compareToIgnoreCase)))).add(client);</span><br><span class="line">            tagIds.add(tagId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">removeTagClient</span><span class="params">(String bizName, String tagId, BaseClient client)</span> &#123;</span><br><span class="line">        List&lt;String&gt; tagIds = (List)client.getTagInfos().get(bizName);</span><br><span class="line">        <span class="keyword">if</span> (tagIds != <span class="literal">null</span> &amp;&amp; tagIds.remove(tagId)) &#123;</span><br><span class="line">            Map&lt;String, ConcurrentSkipListSet&lt;BaseClient&gt;&gt; tagClientMap = (Map)<span class="built_in">this</span>.TAG_CLIENTS.get(bizName);</span><br><span class="line">            <span class="keyword">if</span> (tagClientMap != <span class="literal">null</span>) &#123;</span><br><span class="line">                ConcurrentSkipListSet&lt;BaseClient&gt; clients = (ConcurrentSkipListSet)tagClientMap.get(tagId);</span><br><span class="line">                <span class="keyword">if</span> (clients != <span class="literal">null</span> &amp;&amp; clients.remove(client) &amp;&amp; clients.isEmpty()) &#123;</span><br><span class="line">                    tagClientMap.remove(tagId);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ConcurrentSkipListSet&lt;BaseClient&gt; <span class="title function_">getTagClients</span><span class="params">(String bizName, String tagId)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isEmpty(<span class="built_in">this</span>.TAG_CLIENTS)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Map&lt;String, ConcurrentSkipListSet&lt;BaseClient&gt;&gt; clientByTags = (Map)<span class="built_in">this</span>.TAG_CLIENTS.get(bizName);</span><br><span class="line">            <span class="keyword">return</span> CollectionUtils.isEmpty(clientByTags) ? <span class="literal">null</span> : (ConcurrentSkipListSet)clientByTags.get(tagId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ConcurrentSkipListSet&lt;BaseClient&gt; <span class="title function_">delTagClients</span><span class="params">(String bizName, String tagId)</span> &#123;</span><br><span class="line">        Map&lt;String, ConcurrentSkipListSet&lt;BaseClient&gt;&gt; tagIdClients = (Map)<span class="built_in">this</span>.TAG_CLIENTS.get(bizName);</span><br><span class="line">        <span class="keyword">return</span> CollectionUtils.isEmpty(tagIdClients) ? <span class="literal">null</span> : (ConcurrentSkipListSet)tagIdClients.remove(tagId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addMulticastClient</span><span class="params">(MulticastIdInfo multicastIdInfo, BaseClient client)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!client.getMulticastIdInfos().contains(multicastIdInfo)) &#123;</span><br><span class="line">            ((ConcurrentSkipListSet)<span class="built_in">this</span>.MULTICAST_CLIENTS.computeIfAbsent(multicastIdInfo, (k) -&gt; <span class="keyword">new</span> <span class="title class_">ConcurrentSkipListSet</span>(Comparator.comparing(BaseClient::getSocketId, String::compareToIgnoreCase)))).add(client);</span><br><span class="line">            client.getMulticastIdInfos().add(multicastIdInfo);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">removeMulticastClient</span><span class="params">(MulticastIdInfo multicastIdInfo, BaseClient client)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (client.getMulticastIdInfos().contains(multicastIdInfo)) &#123;</span><br><span class="line">            ConcurrentSkipListSet&lt;BaseClient&gt; clients = (ConcurrentSkipListSet)<span class="built_in">this</span>.MULTICAST_CLIENTS.get(multicastIdInfo);</span><br><span class="line">            <span class="keyword">if</span> (!CollectionUtils.isEmpty(clients)) &#123;</span><br><span class="line">                <span class="type">boolean</span> <span class="variable">removed</span> <span class="operator">=</span> clients.remove(client);</span><br><span class="line">                <span class="keyword">if</span> (removed) &#123;</span><br><span class="line">                    client.getMulticastIdInfos().remove(multicastIdInfo);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ConcurrentSkipListSet&lt;BaseClient&gt; <span class="title function_">delMulticastClient</span><span class="params">(MulticastIdInfo multicastId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (ConcurrentSkipListSet)<span class="built_in">this</span>.MULTICAST_CLIENTS.remove(multicastId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ConcurrentSkipListSet&lt;BaseClient&gt; <span class="title function_">getMulticastClient</span><span class="params">(MulticastIdInfo multicastId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (ConcurrentSkipListSet)<span class="built_in">this</span>.MULTICAST_CLIENTS.get(multicastId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Collection&lt;BaseClient&gt; <span class="title function_">getAllClient</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.ALL_CLIENTS.values();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addClient</span><span class="params">(String socketId, BaseClient baseClient)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.ALL_CLIENTS.put(socketId, baseClient);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">removeClient</span><span class="params">(String socketId)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.ALL_CLIENTS.remove(socketId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> BaseClient <span class="title function_">getClient</span><span class="params">(String socketId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (BaseClient)<span class="built_in">this</span>.ALL_CLIENTS.get(socketId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>数据架构图：</p>
<p><img src="https://blog-image-1257452121.cos.ap-chongqing.myqcloud.com/tag-ability.png" alt="数据架构图"></p>
<p>addTag步骤：</p>
<ol>
<li>rpc调用registerRemoteService.addTag(req): 也就是写上面提到的redis hash </li>
<li>namespaceBox.addTagClient(tagId, client): transmission server存储本地tag信息</li>
</ol>
<p>此外客户端应该定期tagHeart，re expire 续期 tag的这个过期时间，防止上面的300s过期，这里具体实现可以这样，收到客户端包的时候，做tagHeart的续期（下面的update在每次收到客户端报文后被调用，和heart一样有个防频繁调用redis的逻辑）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(BaseClient client)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (CollectionUtils.isEmpty(client.getTagInfos())) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (System.currentTimeMillis() - client.getDeviceInfo().getTs() &lt;= apolloSwitch.getTagHeartbeatInterval()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        tagHeartExecutorService.execute(() -&gt; &#123;</span><br><span class="line">            <span class="type">TagRequestModel</span> <span class="variable">tagRequestModel</span> <span class="operator">=</span> TagRequestModel.create(client, client.getTagInfos());</span><br><span class="line">            rtpCallbackRegisterService.tagHeart(tagRequestModel, <span class="keyword">new</span> <span class="title class_">ICallback</span>&lt;Void&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSuccess</span><span class="params">(Void unused)</span> &#123;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onFail</span><span class="params">(<span class="type">int</span> code, String message)</span> &#123;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">        log.warn(<span class="string">&quot;update tagHeart error, error:&#123;&#125;&quot;</span>, ex.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>removeTag有很细的细节，当客户端来removeTag时，要不要hdel呢? 实际上有个小trick:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 使用lua脚本，防止低版本的删除操作，删了高版本的更新操作，导致多删问题</span></span><br><span class="line"><span class="comment"> * redis里面的数据value很大，而带过来的更新的version比较小，说明有新的用户加入tag了，这时候不能删这个tag对应的ip了</span></span><br><span class="line"><span class="comment"> * 若带过来的版本号大于redis里的版本号，则删除</span></span><br><span class="line"><span class="comment"> * 否则，不删除</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> key</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> field</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> value</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">del</span><span class="params">(String key, String field, String value)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">luaScript</span> <span class="operator">=</span></span><br><span class="line">                <span class="string">&quot;local currentValue = redis.call(&#x27;hget&#x27;, KEYS[1], ARGV[1]) &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;if currentValue and ARGV[2] &gt;= currentValue then &quot;</span> +</span><br><span class="line">                        <span class="string">&quot; redis.call(&#x27;hdel&#x27;, KEYS[1], ARGV[1]) &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;end&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Execute the script.</span></span><br><span class="line">        <span class="comment">// Exceptions or errors would be handled outside or in a caller context.</span></span><br><span class="line">        cacheClient.eval(luaScript, <span class="number">1</span>, key, field, value);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">        log.warn(<span class="string">&quot;del error, key:&#123;&#125;, field:&#123;&#125;&quot;</span>, key, field, ex);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>sync服务有一个按tag下行的接口：逻辑是从redis拿到tansmission server的ipport，然后调用transmission下行：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// tranmission的tag下行接口</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">syncByTag</span><span class="params">(NamespaceClientBox namespaceClientBox, MulticastByTagDto dto)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ConcurrentSkipListSet&lt;BaseClient&gt; clients = namespaceClientBox.getTagClients(dto.getBizName(), dto.getTagId());</span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isEmpty(clients)) &#123;</span><br><span class="line">            MetricsUtils.counter(<span class="string">&quot;multicast_tag_sync&quot;</span>).addTag(<span class="string">&quot;result&quot;</span>, <span class="string">&quot;client_empty&quot;</span>).increment(dto.getSize());</span><br><span class="line">            <span class="comment">// 清远程数据</span></span><br><span class="line">            multicastDataService.removeTagByIp(dto.getDomain(), namespaceClientBox, dto.getBizName(), dto.getTagId());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 记录状态</span></span><br><span class="line">            ApplicationContextProvider.getSyncStateService().record(</span><br><span class="line">                    dto.getSyncStateKeys(),</span><br><span class="line">                    <span class="literal">null</span>,</span><br><span class="line">                    <span class="literal">null</span>,</span><br><span class="line">                    <span class="literal">null</span>,</span><br><span class="line">                    EnumAckStatus.NO_CHANNEL,</span><br><span class="line">                    dto.getTime(), <span class="literal">false</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        clients.forEach(client -&gt; &#123;</span><br><span class="line">            <span class="comment">// 过滤操作</span></span><br><span class="line">            <span class="keyword">if</span> (FilterUtil.selectPush(client, dto.getFilter())) &#123;</span><br><span class="line">                <span class="comment">// 写出去</span></span><br><span class="line">                <span class="type">EnumAckStatus</span> <span class="variable">state</span> <span class="operator">=</span> syncManager.sync(client, dto.getBizName(), dto.getPackets());</span><br><span class="line">                <span class="keyword">if</span> (state == EnumAckStatus.WRITE_TO_CHANNEL) &#123;</span><br><span class="line">                    MetricsUtils.counter(<span class="string">&quot;multicast_tag_sync&quot;</span>).addTag(<span class="string">&quot;result&quot;</span>, EnumAckStatus.WRITE_TO_CHANNEL.name()).increment(dto.getSize());</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                MetricsUtils.counter(<span class="string">&quot;multicast_tag_sync&quot;</span>).addTag(<span class="string">&quot;result&quot;</span>, state.name()).increment(dto.getSize());</span><br><span class="line">                ApplicationContextProvider.getSyncStateService().record(</span><br><span class="line">                        dto.getSyncStateKeys(),</span><br><span class="line">                        client.getSocketId(),</span><br><span class="line">                        client.getLoginUser().getAlias(),</span><br><span class="line">                        client.getPlatformType(),</span><br><span class="line">                        state,</span><br><span class="line">                        dto.getTime(), <span class="literal">false</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            MetricsUtils.counter(<span class="string">&quot;multicast_tag_sync&quot;</span>).addTag(<span class="string">&quot;result&quot;</span>, EnumAckStatus.FILTER.name()).increment(dto.getSize());</span><br><span class="line">            <span class="comment">// 过滤</span></span><br><span class="line">            ApplicationContextProvider.getSyncStateService().record(</span><br><span class="line">                    dto.getSyncStateKeys(),</span><br><span class="line">                    client.getSocketId(),</span><br><span class="line">                    client.getLoginUser().getAlias(),</span><br><span class="line">                    client.getPlatformType(),</span><br><span class="line">                    EnumAckStatus.FILTER,</span><br><span class="line">                    dto.getTime(), <span class="literal">false</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">        log.warn(<span class="string">&quot;process tagId:&#123;&#125; error&quot;</span>, dto.getTagId(), ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

    
  </div>
  <footer>
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>

</div>
  </div>
  <footer id="footer"><div class="copyright">
  
  &copy; 2025 <a href="/">Markity</a>
  
</div>
<div class="theme-copyright">
  Theme by <a href="https://github.com/orderedlist" target="_blank">orderedlist</a>
   | 
  Redesign by <a href="http://heroicyang.com/" target="_blank">Heroic Yang</a>
</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
<script src="/js/scale.fix.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
  (function($){
    $('.fancybox').fancybox();
  })(jQuery);
</script>

</body>
</html>
<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  
  <title>《lua程序设计》学习记录 | Markity&#39;s Notes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  
    <meta name="author" content="Markity">
  
  
    <meta name="description" content="前言为了配合redis做原子操作学习lua, 正在读《Lua程序设计》, 此书短小精悍, 应该几日就能读完, 记下这篇笔记便于回忆。正在持续施工中…">
  
  <meta name="description" content="前言为了配合redis做原子操作学习lua, 正在读《Lua程序设计》, 此书短小精悍, 应该几日就能读完, 记下这篇笔记便于回忆。正在持续施工中…">
<meta property="og:type" content="article">
<meta property="og:title" content="《lua程序设计》学习记录">
<meta property="og:url" content="http://example.com/2023/03/19/lua/index.html">
<meta property="og:site_name" content="Markity&#39;s Notes">
<meta property="og:description" content="前言为了配合redis做原子操作学习lua, 正在读《Lua程序设计》, 此书短小精悍, 应该几日就能读完, 记下这篇笔记便于回忆。正在持续施工中…">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2023-03-18T16:57:55.000Z">
<meta property="article:modified_time" content="2023-05-19T05:20:14.000Z">
<meta property="article:author" content="Markity">
<meta property="article:tag" content="lua">
<meta property="article:tag" content="notes">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Markity&#39;s Notes" type="application/atom+xml">
  
  
    <link rel="icon" type="image/x-icon" href="https://blog-image-1257452121.cos.ap-chongqing.myqcloud.com/avatar.jpg">
  
  
<link rel="stylesheet" href="/css/style.css">

  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div class="wrapper">
    <header id="header">
  <div class="title">
    <h1><a href="/">Markity&#39;s Notes</a></h1>
    <p><a href="/"></a></p>
  </div>
  <nav class="nav">
    <ul>
      
        <li><a href="/">Home</a></li>
      
        <li><a href="/archives">Archives</a></li>
      
      
        <li><a href="/atom.xml">RSS</a></li>
      
    </ul>
    <div class="clearfix"></div>
  </nav>
  <div class="clearfix"></div>
</header>
    <div class="content"><article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2023/03/19/lua/">
  <time datetime="2023-03-18T16:57:55.000Z">
    2023-03-19
  </time>
</a>
    
    
  
    <h1 class="title">《lua程序设计》学习记录</h1>
  

  </header>
  
  <div class="entry">
    
      <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>为了配合redis做原子操作学习lua, 正在读《Lua程序设计》, 此书短小精悍, 应该几日就能读完, 记下这篇笔记便于回忆。正在持续施工中…</p>
<span id="more"></span>

<h3 id="A-Very-Beginning-Hello-World"><a href="#A-Very-Beginning-Hello-World" class="headerlink" title="A Very Beginning: Hello World"></a>A Very Beginning: Hello World</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Hello World&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 行注释</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--[[</span></span><br><span class="line"><span class="comment">    多行注释</span></span><br><span class="line"><span class="comment">]]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- output: Hello World</span></span><br></pre></td></tr></table></figure>

<p>学习编程语言的开始, 感觉回到了python。lua用<code>--</code>注释行, 用<code>--[[...]]--</code>注释多行。</p>
<h3 id="一个简洁的例子-fact"><a href="#一个简洁的例子-fact" class="headerlink" title="一个简洁的例子: fact"></a>一个简洁的例子: fact</h3><p>下面简要演示了lua语言的语法图景, 有个简单的印象:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fact</span><span class="params">(n)</span></span></span><br><span class="line">    <span class="keyword">if</span> n == <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> n * fact(n<span class="number">-1</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;enter a number: &quot;</span>)</span><br><span class="line">a = <span class="built_in">io</span>.<span class="built_in">read</span>(<span class="string">&quot;*number&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(fact(a))</span><br></pre></td></tr></table></figure>

<h3 id="词法规范的特殊规则"><a href="#词法规范的特殊规则" class="headerlink" title="词法规范的特殊规则"></a>词法规范的特殊规则</h3><ul>
<li>避免用一个下划线跟着一个或多个大写字母作为标识符, 因为这类标识符有特殊的用途。</li>
</ul>
<p>在命令行里打<code>lua</code>, 然后就进入了lua的交互式模式, 此时输入<code>_PROMPT = &#39;$ &#39;</code>, 这样你的lua交互模式的命令提示符就变成<code>$ </code>了, 这是特殊用途之一。</p>
<p>还有其它的特殊用途我现在还不知道(TODO)。</p>
<ul>
<li>不用一个下划线作为标识符, 一个下划线作为”哑变量”使用。哑变量是什么我现在不知道(TODO)。</li>
</ul>
<h3 id="解除多行注释"><a href="#解除多行注释" class="headerlink" title="解除多行注释"></a>解除多行注释</h3><p>下面介绍了一个奇技淫巧:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 加一个-字符, 这样可以启用多行注释内的代码</span></span><br><span class="line"></span><br><span class="line"><span class="comment">---[[</span></span><br><span class="line"><span class="built_in">print</span>(<span class="number">10</span>)</span><br><span class="line"><span class="comment">--]]</span></span><br></pre></td></tr></table></figure>

<h3 id="获得脚本参数"><a href="#获得脚本参数" class="headerlink" title="获得脚本参数"></a>获得脚本参数</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="built_in">arg</span>[<span class="number">-1</span>])</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">arg</span>[<span class="number">0</span>])</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">arg</span>[<span class="number">1</span>])</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">arg</span>[<span class="number">2</span>])</span><br></pre></td></tr></table></figure>

<p>执行<code>lua main.lua 1 2</code>打印出<code>lua</code>, <code>main.lua</code>, <code>1</code>和<code>2</code>。</p>
<h3 id="类型"><a href="#类型" class="headerlink" title="类型"></a>类型</h3><p>lua类型是动态的, 每个标识符都携带了它自身的类型信息, 标识符可以赋不同类型的值。下面是全部类型:</p>
<ul>
<li>nil</li>
<li>boolean: true or false</li>
<li>number: 双精度浮点数, lua没有整数类型, 支持科学计数比如<code>a = 5e12</code>, <code>b = 5e-3</code></li>
<li>string: 可以用单引号, 双引号, <code>[[]]</code>包裹。它不应该被认为是字符串, 应该被认为是字节序列才对。和java很类似, 字符串是”只读”的</li>
<li>function: 函数</li>
<li>userdata: 自定义类型</li>
<li>thread: 线程</li>
<li>table: 表, 可以用来做list或哈希表</li>
</ul>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(<span class="string">&quot;Hello world&quot;</span>))      <span class="comment">--&gt; string</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(<span class="number">10.4</span>*<span class="number">3</span>))             <span class="comment">--&gt; number</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(<span class="built_in">print</span>))              <span class="comment">--&gt; function</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(<span class="built_in">type</span>))               <span class="comment">--&gt; function</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(<span class="literal">true</span>))               <span class="comment">--&gt; boolean</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(<span class="literal">nil</span>))                <span class="comment">--&gt; nil</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(<span class="built_in">type</span>(X)))            <span class="comment">--&gt; string, 表明type(X)的返回值是string</span></span><br></pre></td></tr></table></figure>

<h3 id="关于number的误解"><a href="#关于number的误解" class="headerlink" title="关于number的误解"></a>关于number的误解</h3><p>有人认为lua应该支持整数类型, 那其实是不必要的, 只要用双精度的变量存放整数, 就和整数没有区别。</p>
<h3 id="变量和作用域"><a href="#变量和作用域" class="headerlink" title="变量和作用域"></a>变量和作用域</h3><p>基本概念:</p>
<ul>
<li>使用没有创建的变量读取后为nil, 也可以对创建的变量写为nil来体现”删除这个变量”的意图, 可以认为读取为nil的变量就是不存在的变量</li>
<li>变量分为全局变量, 局部变量</li>
<li>变量的类型是动态类型, 每个标识符都存储了自身的类型</li>
</ul>
<p>实验, 读取不存在的变量返回nil:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(not_found)</span><br><span class="line"></span><br><span class="line"><span class="comment">--- output: nil</span></span><br></pre></td></tr></table></figure>

<p>局部变量必须用<code>local</code>显示指定:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="number">1</span>                   <span class="comment">--- 全局变量</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">func1</span><span class="params">()</span></span></span><br><span class="line">    b = <span class="number">10</span>              <span class="comment">--- 全局变量</span></span><br><span class="line">    <span class="keyword">local</span> a = <span class="number">11</span>        <span class="comment">--- 局部变量</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">func2</span><span class="params">()</span></span></span><br><span class="line">    b = <span class="number">20</span>              <span class="comment">--- 全局变量</span></span><br><span class="line">    a = <span class="number">111</span>             <span class="comment">--- 全局变量</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(a, b)</span><br><span class="line">func1()</span><br><span class="line"><span class="built_in">print</span>(a, b)             <span class="comment">--- 调用这个函数, 全局变量就被声明了, 可见全局变量自由度很高</span></span><br><span class="line">func2()</span><br><span class="line"><span class="built_in">print</span>(a, b)</span><br><span class="line"></span><br><span class="line"><span class="comment">--- output</span></span><br><span class="line"><span class="comment">--- 1   nil</span></span><br><span class="line"><span class="comment">--- 1   10</span></span><br><span class="line"><span class="comment">--- 111 20</span></span><br></pre></td></tr></table></figure>

<p>对局部变量, 与python不同, 变量的作用域与c类似, 块内部声明的变量块外无法访问, 且块内的局部变量声明能覆盖块外面的(这点很好, python的作用域太烂了):</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>  <span class="title">fun</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> a = <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> a == <span class="number">1</span></span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">        <span class="comment">-- 与外部的a无关, 这个词法块有自己的a</span></span><br><span class="line">        <span class="keyword">local</span> a = <span class="number">2</span></span><br><span class="line">        <span class="keyword">local</span> b = <span class="number">3</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(a)    <span class="comment">-- 1</span></span><br><span class="line">    <span class="built_in">print</span>(b)    <span class="comment">-- nil 超出块作用域</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">fun()</span><br></pre></td></tr></table></figure>

<p>词法作用域:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">val = <span class="number">1</span></span><br><span class="line">​</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span><span class="params">()</span></span></span><br><span class="line">    <span class="built_in">print</span>(val)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">​</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">bar</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> val = <span class="number">2</span></span><br><span class="line">    foo()</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">​</span><br><span class="line">bar()</span><br></pre></td></tr></table></figure>

<p>这里的答案是1, 在函数定义期间, 内部变量的作用域已经确定了, foo内的val被认定是全局变量。</p>
<p>闭包的作用域:</p>
<p>这点很复杂, 放在后面讨论。</p>
<p>支持像go一样的多值赋值, 先解析右边, 然后依次赋值给左边, 这样可以做到不引入第三方变量而做交换操作:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">x, y = y, x</span><br></pre></td></tr></table></figure>

<p>疑问, 最外层的local有什么意义?(TODO)</p>
<h3 id="交互式模式下的作用域"><a href="#交互式模式下的作用域" class="headerlink" title="交互式模式下的作用域:"></a>交互式模式下的作用域:</h3><p>在交互式模式下, 会为每行完整的指令生成一个程序块, 下面是一个很常见的”bug”:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="keyword">local</span> i = <span class="number">1</span></span><br><span class="line">$ <span class="built_in">print</span>(i)</span><br><span class="line"><span class="literal">nil</span></span><br></pre></td></tr></table></figure>

<p>要解决这个问题, 就别使用完整的指令, 可以用<code>do-end</code>自己构造一个程序块, 直到此程序块结束时, 才一次性执行里面的命令:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">do</span> <span class="keyword">local</span> i = <span class="number">1</span></span><br><span class="line">&gt;&gt; <span class="built_in">print</span>(i)</span><br><span class="line">&gt;&gt; <span class="keyword">end</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>

<h3 id="直接屏蔽掉外层的local变量-来避免冲突"><a href="#直接屏蔽掉外层的local变量-来避免冲突" class="headerlink" title="直接屏蔽掉外层的local变量, 来避免冲突"></a>直接屏蔽掉外层的local变量, 来避免冲突</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> a = <span class="number">1</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="keyword">local</span> a <span class="comment">-- 隐式的local a = nil</span></span><br><span class="line">    <span class="comment">-- do something with a...</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="运算符"><a href="#运算符" class="headerlink" title="运算符"></a>运算符</h3><ul>
<li>+: 加</li>
<li>-: 减 或 取负</li>
<li>*: 乘</li>
<li>&#x2F;: 除法</li>
<li>%: 取模</li>
<li>^: 次方</li>
<li>&#x2F;&#x2F;: 整除后向下取整数</li>
<li>and: 且</li>
<li>or: 或</li>
<li>not: 否</li>
<li>..: 字符串连接, 值得一提的是number也能做字符串连接, 但需要前面的元素一定是字符串, 比如<code>10..&quot;hello&quot;</code>不合法</li>
<li>#: 返回字符串或者table的长度, 对字符串是字节数目</li>
</ul>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">&quot;hello&quot;</span>.<span class="number">.10</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">--- output: hello10</span></span><br></pre></td></tr></table></figure>

<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(#<span class="string">&quot;你好world&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="if条件判断"><a href="#if条件判断" class="headerlink" title="if条件判断"></a>if条件判断</h3><p>在if中nil, false被规定为”假”, 其它都视为真。为了代码的严谨性, 别依赖这些假设, 统统用true&#x2F;false就完了。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="number">1.1</span>)</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;ok&quot;</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="string">&quot;我&quot;</span>)</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;ok&quot;</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--- output:</span></span><br><span class="line"><span class="comment">--- ok</span></span><br><span class="line"><span class="comment">--- ok</span></span><br></pre></td></tr></table></figure>

<h3 id="循环结构"><a href="#循环结构" class="headerlink" title="循环结构"></a>循环结构</h3><p>while:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="number">1</span></span><br><span class="line"><span class="keyword">while</span>(a &lt;= <span class="number">10</span>)</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="built_in">print</span>(a)</span><br><span class="line">    a = a + <span class="number">1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--- output: 打印1-10</span></span><br></pre></td></tr></table></figure>

<p>for:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i=<span class="number">10</span>,<span class="number">1</span>,<span class="number">-1</span> <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">print</span>(i)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--- output: 打印10-1</span></span><br></pre></td></tr></table></figure>

<p>含义, 从10变到1(包含1),-1为步长(lua的语法题太甜了)。注意, 此处i其实被声明成了一个局部变量, 作用域在do内部。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i=<span class="number">1</span>,<span class="number">10</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="built_in">print</span>(i)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--- output: 打印1-10</span></span><br></pre></td></tr></table></figure>

<p>因为默认步长为1。</p>
<p>repeat until:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">i = <span class="number">1</span></span><br><span class="line"><span class="keyword">repeat</span></span><br><span class="line">    <span class="built_in">print</span>(i)</span><br><span class="line">    i = i + <span class="number">1</span></span><br><span class="line"><span class="keyword">until</span> (i == <span class="number">11</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">--- output: 打印1-11</span></span><br></pre></td></tr></table></figure>

<p>循环控制:</p>
<p>可以使用break来结束一个循环, lua规定break是一个块的最后一个语句。有时候需要做调试, 在块的中间插入一个break, 可以这样做。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">...一些代码</span><br><span class="line"><span class="keyword">do</span> <span class="keyword">break</span> <span class="keyword">end</span></span><br><span class="line">...一些代码</span><br></pre></td></tr></table></figure>

<p>泛型for, 通过迭代器来遍历所有值:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">a = &#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>&#125;</span><br><span class="line"><span class="keyword">for</span> i,v <span class="keyword">in</span> <span class="built_in">ipairs</span>(a) <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">print</span>(i, v)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--[[ output:</span></span><br><span class="line"><span class="comment">1       1</span></span><br><span class="line"><span class="comment">2       2</span></span><br><span class="line"><span class="comment">3       3</span></span><br><span class="line"><span class="comment">4       4</span></span><br><span class="line"><span class="comment">5       5</span></span><br><span class="line"><span class="comment">6       6</span></span><br><span class="line"><span class="comment">--]]</span></span><br></pre></td></tr></table></figure>

<p>ipairs是lua基础库提供的函数, 每次循环, i被赋予为键, v被赋予为值。对table可以使用下面的迭代器:</p>
<ul>
<li>ipairs: 迭代数组类型table的key和value, 仅限键为数字的</li>
<li>pairs: 迭代table的key和value, 键值对</li>
</ul>
<h3 id="table用法1-实现map"><a href="#table用法1-实现map" class="headerlink" title="table用法1: 实现map"></a>table用法1: 实现map</h3><p>表是把索引映射到值的”关联数组”类型。标识符包含了table类型和它的一个指针, 也就是说它是一个引用类型。要创建一个brand new的table, 需要用构造表达式:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a = &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>table常常用来做映射, 键可以为非nil的数据类型, 值可以是所有类型, 如果键不存在, 那么取到的值为nil:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 用来表示用户名代表的余额:</span></span><br><span class="line">a = &#123;&#125;</span><br><span class="line">a[<span class="string">&quot;Jack&quot;</span>] = <span class="number">1000</span></span><br><span class="line">a[<span class="string">&quot;Mary&quot;</span>] = <span class="number">2000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 验证&quot;引用类型&quot;的论断</span></span><br><span class="line">b = a</span><br><span class="line">b[<span class="string">&quot;Mark&quot;</span>] = <span class="number">3000</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(a[<span class="string">&quot;Jack&quot;</span>])</span><br><span class="line"><span class="built_in">print</span>(a[<span class="string">&quot;Mary&quot;</span>])</span><br><span class="line"><span class="built_in">print</span>(a[<span class="string">&quot;Mark&quot;</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment">--[[ output:</span></span><br><span class="line"><span class="comment">1000</span></span><br><span class="line"><span class="comment">2000</span></span><br><span class="line"><span class="comment">3000</span></span><br><span class="line"><span class="comment">--]]</span></span><br></pre></td></tr></table></figure>

<p>下面进行一个实现, 看看将某个键对应的值设置为nil, 能不能起到删除的效果:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">a = &#123;&#125;</span><br><span class="line">a[<span class="string">&quot;x&quot;</span>] = <span class="number">10</span></span><br><span class="line">a[<span class="string">&quot;x&quot;</span>] = <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> k,v <span class="keyword">in</span> <span class="built_in">pairs</span>(a) <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">print</span>(k,v)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(#a)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">select</span>(<span class="string">&#x27;#&#x27;</span>, ...))</span><br><span class="line"></span><br><span class="line"><span class="comment">--[[ output:</span></span><br><span class="line"><span class="comment">0</span></span><br><span class="line"><span class="comment">0</span></span><br><span class="line"><span class="comment">--]]</span></span><br></pre></td></tr></table></figure>

<p>因此根据lua的设计哲学, nil即不存在, 那么可以认为值为nil则对应键不存在。</p>
<p>一种神奇的语法糖:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a[<span class="string">&quot;x&quot;</span>] = <span class="number">10</span></span><br><span class="line"><span class="built_in">print</span>(a.x)</span><br></pre></td></tr></table></figure>

<p>这种语法糖专用于键为string, <code>a[&quot;x&quot;]</code>此时等价于<code>a.x</code>。</p>
<h3 id="table用法2-数组"><a href="#table用法2-数组" class="headerlink" title="table用法2: 数组"></a>table用法2: 数组</h3><p>只需要把整数作为key来使用table就行了。下面的代码读取10行内容存储到table中, 并将其打印出来:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">a = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> i = <span class="number">1</span>, <span class="number">10</span>, <span class="number">1</span> <span class="keyword">do</span></span><br><span class="line">    a[i] = <span class="built_in">io</span>.<span class="built_in">read</span>()    </span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i = <span class="number">1</span>, <span class="number">10</span>, <span class="number">1</span> <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">print</span>(a[i])</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>在lua的习惯中, 数组通常以1作为索引起始值。对于<code>#</code>运算符, 用于返回数组的长度, 为了看清它的逻辑, 下面演示一种空洞的情况:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">a = &#123;&#125;</span><br><span class="line">a[<span class="number">-2</span>] = <span class="number">0</span></span><br><span class="line">a[<span class="number">1</span>] = <span class="number">10</span></span><br><span class="line">a[<span class="number">2</span>] = <span class="number">20</span></span><br><span class="line">a[<span class="number">10</span>] = <span class="number">30</span></span><br><span class="line"><span class="built_in">print</span>(#a)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- output: 2</span></span><br></pre></td></tr></table></figure>

<p><code>#</code>对table的原理就是, 从1开始计数, 一直数到nil, 中间到底有多少个元素。因此这里的返回结果为2。</p>
<p>如果要得到具有空洞的数组最大的索引值, 可以用下面的方法(table.maxn已经被移除, 我们自己实现个一样的):</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">table_maxn</span><span class="params">(t)</span></span></span><br><span class="line">  <span class="keyword">local</span> mn=<span class="literal">nil</span>;</span><br><span class="line">  <span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">pairs</span>(t) <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">if</span>(mn==<span class="literal">nil</span>) <span class="keyword">then</span></span><br><span class="line">      mn=v</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">if</span> mn &lt; v <span class="keyword">then</span></span><br><span class="line">      mn = v</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">return</span> mn</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>


<h3 id="table构造式的多种用法"><a href="#table构造式的多种用法" class="headerlink" title="table构造式的多种用法"></a>table构造式的多种用法</h3><p>三种构造法:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- days[1] = &quot;Sunday&quot;...</span></span><br><span class="line">days = &#123;<span class="string">&quot;Sunday&quot;</span>, <span class="string">&quot;Monday&quot;</span>, <span class="string">&quot;Tuesday&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- salary.Jack = 1000...</span></span><br><span class="line">salary = &#123;Jack=<span class="number">1000</span>, Mark=<span class="number">2000</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- opcodes[&quot;+&quot;] = &quot;add&quot;...</span></span><br><span class="line">opcodes = &#123;</span><br><span class="line">    [<span class="string">&quot;+&quot;</span>] = <span class="string">&quot;add&quot;</span>,</span><br><span class="line">    [<span class="string">&quot;-&quot;</span>] = <span class="string">&quot;sub&quot;</span>,</span><br><span class="line">    [<span class="string">&quot;*&quot;</span>] = <span class="string">&quot;mul&quot;</span>,</span><br><span class="line">    [<span class="string">&quot;/&quot;</span>] = <span class="string">&quot;div&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>牛逼应用, 做一个链表, 按输入相反的次序存储:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">list = <span class="literal">nil</span></span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> <span class="built_in">io</span>.<span class="built_in">lines</span>() <span class="keyword">do</span></span><br><span class="line">    list = &#123;<span class="built_in">next</span>=list,value=line&#125;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">l = list</span><br><span class="line"><span class="keyword">while</span> l <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">print</span>(l.value)</span><br><span class="line">    l = l.<span class="built_in">next</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--[[ input:</span></span><br><span class="line"><span class="comment">1</span></span><br><span class="line"><span class="comment">2</span></span><br><span class="line"><span class="comment">3</span></span><br><span class="line"><span class="comment">--]]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--[[ output:</span></span><br><span class="line"><span class="comment">3</span></span><br><span class="line"><span class="comment">2</span></span><br><span class="line"><span class="comment">1</span></span><br><span class="line"><span class="comment">--]]</span></span><br></pre></td></tr></table></figure>

<p>混合构造:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">polyline = &#123;</span><br><span class="line">    color=<span class="string">&quot;blue&quot;</span>,</span><br><span class="line">    thickness=<span class="number">2</span>,</span><br><span class="line">    npoints=<span class="number">4</span>,</span><br><span class="line">    &#123;x=<span class="number">0</span>, y=<span class="number">0</span>&#125;,</span><br><span class="line">    &#123;x=<span class="number">-10</span>, y=<span class="number">0</span>&#125;,</span><br><span class="line">    &#123;x=<span class="number">-10</span>, y=<span class="number">1</span>&#125;,</span><br><span class="line">    &#123;x=<span class="number">0</span>, y=<span class="number">1</span>&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(polyline.color)</span><br><span class="line"><span class="built_in">print</span>(polyline[<span class="number">2</span>].x, polyline[<span class="number">2</span>].y)</span><br><span class="line"></span><br><span class="line"><span class="comment">--[[ output:</span></span><br><span class="line"><span class="comment">blue</span></span><br><span class="line"><span class="comment">10  0</span></span><br><span class="line"><span class="comment">--]]</span></span><br></pre></td></tr></table></figure>

<h3 id="string-字符串-更准确的说是字节集合"><a href="#string-字符串-更准确的说是字节集合" class="headerlink" title="string: 字符串(更准确的说是字节集合)"></a>string: 字符串(更准确的说是字节集合)</h3><p>用单引号&#x2F;双引号&#x2F;<code>[n个等号[]n个等号]</code>包裹形成字符串:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="string">&#x27;Hello World&#x27;</span></span><br><span class="line">a = <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">a = <span class="string">[[Hello World]]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 下面这种方法是为了解决某种冲突, 和markdown代码块里面包含```如出一辙</span></span><br><span class="line">a = <span class="string">[===[Hello World]===]</span></span><br></pre></td></tr></table></figure>

<p>当字符串和number进行运算时, 字符串会尝试自动转化为number:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">&quot;12345&quot;</span>+<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- output: 12346</span></span><br></pre></td></tr></table></figure>

<p><code>..</code>运算符, 可以连接字符串:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Hello&quot;</span>..<span class="string">&quot; World&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="number">10</span> .. <span class="number">20</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="number">10</span> .. <span class="string">&quot;Hello&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">--[[ output:</span></span><br><span class="line"><span class="comment">Hello World</span></span><br><span class="line"><span class="comment">1020</span></span><br><span class="line"><span class="comment">10Hello</span></span><br><span class="line"><span class="comment">--]]</span></span><br></pre></td></tr></table></figure>

<p><code>#</code>运算符被用作获得字符串的字节长度:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(#<span class="string">&quot;Hello&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- output: 5</span></span><br></pre></td></tr></table></figure>

<p><code>string</code>包提供了很多方法来操作字符串。其中很多方法都是面向英语编程即可, 这里提几个特别的。</p>
<p>字符串替换:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">---@param s       string</span></span><br><span class="line"><span class="comment">---@param pattern string</span></span><br><span class="line"><span class="comment">---@param repl    string|number|table|function</span></span><br><span class="line"><span class="comment">---@param n?      integer</span></span><br><span class="line"><span class="comment">---@return string</span></span><br><span class="line"><span class="comment">---@return integer count</span></span><br><span class="line"><span class="comment">---@nodiscard</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">string.gsub</span><span class="params">(s, pattern, repl, n)</span></span></span><br></pre></td></tr></table></figure>

<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="string">&quot;hello world&quot;</span></span><br><span class="line">b = <span class="built_in">string</span>.<span class="built_in">gsub</span>(a, <span class="string">&quot;world&quot;</span>, <span class="string">&quot;markity&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(a)</span><br><span class="line"><span class="built_in">print</span>(b)</span><br><span class="line"></span><br><span class="line"><span class="comment">--[[ output:</span></span><br><span class="line"><span class="comment">hello world</span></span><br><span class="line"><span class="comment">hello markity</span></span><br><span class="line"><span class="comment">--]]</span></span><br></pre></td></tr></table></figure>

<p>s是被操作的字符串。pattern是原字符串, repl是替换字符串, n可选代表替换最多次数, 如果忽略则全部进行替换。</p>
<p>获取字符串的某些字节:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">---@param s  string</span></span><br><span class="line"><span class="comment">---@param i? integer</span></span><br><span class="line"><span class="comment">---@param j? integer</span></span><br><span class="line"><span class="comment">---@return integer ...</span></span><br><span class="line"><span class="comment">---@nodiscard</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">string.byte</span><span class="params">(s, i, j)</span></span> <span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="string">&quot;hello world&quot;</span></span><br><span class="line">result = &#123;<span class="built_in">string</span>.<span class="built_in">byte</span>(a, <span class="number">1</span>, <span class="number">5</span>)&#125;</span><br><span class="line"><span class="built_in">print</span>(result[<span class="number">1</span>], result[<span class="number">2</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment">-- output: 104 101</span></span><br></pre></td></tr></table></figure>

<p>s是被操作的字符串, i是开始索引(以1开始), j是结束索引(包含它)。返回值被标记为<code>integer ...</code>, 在”函数”中讨论这个。</p>
<h3 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h3><p>简单入门:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span><span class="params">(a, b)</span></span></span><br><span class="line">    <span class="keyword">return</span> a+b</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(add(<span class="number">10</span>, <span class="number">20</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">-- output: 30</span></span><br></pre></td></tr></table></figure>

<p>函数的参数是局部, 也就是local的, 这点需要注意。</p>
<p>当参数只有一个且为字符串字面量或table构造式时, 括号可有可无:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="built_in">print</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">Hello World</span><br><span class="line">&gt; <span class="built_in">type</span> &#123;&#125;</span><br><span class="line"><span class="built_in">table</span></span><br></pre></td></tr></table></figure>

<p>面向对象的特殊调用: 冒号运算符</p>
<p>TODO: 后面介绍</p>
<p>参数传递多或少的问题:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f</span><span class="params">(a,b)</span></span> <span class="keyword">return</span> a <span class="keyword">or</span> b <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">f(<span class="number">3</span>)    <span class="comment">-- a=3, b=nil</span></span><br><span class="line">f(<span class="number">3</span>,<span class="number">4</span>)  <span class="comment">-- a=3, b=4</span></span><br><span class="line">f(<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>)<span class="comment">-- a=3, b=4, 5被丢弃了</span></span><br></pre></td></tr></table></figure>

<p>这里的行为和赋值的参数多或少一个意思, 比如:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="number">10</span>, <span class="number">20</span> <span class="comment">-- 20被丢弃</span></span><br><span class="line">a, b, c = <span class="number">0</span> <span class="comment">-- a = 0, b = nil, c = nil</span></span><br></pre></td></tr></table></figure>

<p>无返回值, 等价于返回nil:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span><span class="params">()</span></span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">x = foo()  <span class="comment">-- x = nil</span></span><br></pre></td></tr></table></figure>

<p>多返回值:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">swap</span><span class="params">(a, b)</span></span></span><br><span class="line">    <span class="keyword">return</span> b, a</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(swap(<span class="number">10</span>, <span class="number">20</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">-- output: 20 10</span></span><br></pre></td></tr></table></figure>

<p>另外一个例子:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo1</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;a&quot;</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo2</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">x,y,z = foo1(), foo2()</span><br><span class="line"></span><br><span class="line"><span class="comment">-- x=&quot;a,&quot;, y=&quot;b&quot;, z=&quot;c&quot;</span></span><br></pre></td></tr></table></figure>

<p>奇葩情况:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 奇葩情况1</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo2</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">x, y = foo2(), <span class="number">20</span></span><br><span class="line"><span class="built_in">print</span>(x, y)</span><br><span class="line"><span class="comment">-- output: a       20</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 奇葩情况2</span></span><br><span class="line"><span class="built_in">print</span>(foo2() .. <span class="number">20</span>)</span><br><span class="line"><span class="comment">-- output: a20</span></span><br></pre></td></tr></table></figure>

<p>对于第一种奇葩情况保持规避态度, 第二种是因为多返回值函数参与运算时, 返回值个数会被调整为1。</p>
<p>table构造式中的多返回值:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo2</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">a = &#123;foo2()&#125;  <span class="comment">-- a[1]=&quot;a&quot;, a[2]=&quot;b&quot;</span></span><br></pre></td></tr></table></figure>

<p>unpace函数(TODO:为什么这个函数被遗弃了?):</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a, b = <span class="built_in">unpack</span>&#123;<span class="number">10</span>,<span class="number">20</span>&#125;</span><br></pre></td></tr></table></figure>

<p>unpack仅仅接收一个参数, 将数组”解包”, 因为参数类型为table字面值, 所以这里可以省略括号。</p>
<p>变长参数:</p>
<p><code>...</code>表示函数可以接受不同数量的实参, 代表0个或多个参数的集合。在函数中, 如果需要使用变长参数, 需要用<code>&#123;...&#125;</code>生成数组, 看下面的例子:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sum</span><span class="params">(...)</span></span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;传入&quot;</span>..#&#123;...&#125;..<span class="string">&quot;个数字&quot;</span>)</span><br><span class="line">    <span class="keyword">local</span> result = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i,v <span class="keyword">in</span> <span class="built_in">ipairs</span>(&#123;...&#125;) <span class="keyword">do</span> </span><br><span class="line">        result = result + v</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(sum(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">-- output:</span></span><br><span class="line"><span class="comment">-- 传入3个数字</span></span><br><span class="line"><span class="comment">-- 6</span></span><br></pre></td></tr></table></figure>

<p><code>...</code>仅仅代表表达式, 可以理解为多个参数用逗号分隔。要拿出可变参数数组, 还得用<code>&#123;...&#125;</code>分隔。</p>
<p>可以认为有这样的关系, 即: <code>unpack(&#123;...&#125;) 等价于 ...</code>。</p>
<p>需要传参时, <code>...</code>也可以指代所有的参数集合:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">printEachForLine</span><span class="params">(...)</span></span></span><br><span class="line">    <span class="comment">-- 别忘了这个语法糖, func(&#123;...&#125;) == func&#123;...&#125;</span></span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">ipairs</span>&#123;...&#125; <span class="keyword">do</span></span><br><span class="line">        <span class="built_in">print</span>(v)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">printEachForLine(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">--[[ output:</span></span><br><span class="line"><span class="comment">1</span></span><br><span class="line"><span class="comment">2</span></span><br><span class="line"><span class="comment">3</span></span><br><span class="line"><span class="comment">]]</span></span><br></pre></td></tr></table></figure>

<p>我们可以利用可变参数实现unpack的逆向操作pack:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pack</span><span class="params">(...)</span></span></span><br><span class="line">    <span class="keyword">return</span> &#123;...&#125;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>这个操作没啥意义, 就是写着玩的。因为<code>&#123;v1, v2, v3&#125;</code>就是pack操作, 不比这个简单?</p>
<p>如果需要传入几个固定参数+可变参数, 那么这么写:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">func</span><span class="params">(arg1, arg2, ...)</span></span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>下面我们来实现printf:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">printf</span><span class="params">(fmt, ...)</span></span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">io</span>.<span class="built_in">write</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(fmt, ...))</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">printf(<span class="string">&quot;Hello %s\n&quot;</span>, <span class="string">&quot;Markity&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>select函数专门用来判断可变参数的个数:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">test</span><span class="params">(...)</span></span></span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">select</span>(<span class="string">&#x27;#&#x27;</span>, ...))</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">test(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>)</span><br><span class="line">test(<span class="number">1</span>,<span class="number">2</span>,<span class="literal">nil</span>)</span><br><span class="line">test(<span class="number">1</span>,<span class="number">2</span>,<span class="literal">nil</span>,<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">--[[ output:</span></span><br><span class="line"><span class="comment">3</span></span><br><span class="line"><span class="comment">3</span></span><br><span class="line"><span class="comment">4</span></span><br><span class="line"><span class="comment">--]]</span></span><br></pre></td></tr></table></figure>

<p>那么select和<code>#</code>有什么区别呢:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">test</span><span class="params">(...)</span></span></span><br><span class="line">    <span class="built_in">print</span>(#&#123;...&#125;)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">test(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>)</span><br><span class="line">test(<span class="number">1</span>,<span class="number">2</span>,<span class="literal">nil</span>)</span><br><span class="line">test(<span class="number">1</span>,<span class="number">2</span>,<span class="literal">nil</span>,<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">--[[ output:</span></span><br><span class="line"><span class="comment">3</span></span><br><span class="line"><span class="comment">2</span></span><br><span class="line"><span class="comment">4</span></span><br><span class="line"><span class="comment">]]</span></span><br></pre></td></tr></table></figure>

<p>这里的区别不言而喻, <code>#</code>运算符会拿取table中最大的数字索引值作为参数。</p>
<p>而select会拿取所有, 管它是否为nil, 这就像开外挂一样嘛?(TODO: 这里的select和#包括ipairs,pairs是怎么实现的?)</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">a = &#123;[<span class="string">&quot;a&quot;</span>]=<span class="string">&quot;test&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> k,v <span class="keyword">in</span> <span class="built_in">ipairs</span>(a) <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">print</span>(k,v)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>传参的较好实践:</p>
<p>不要忘记对于table构造式和string字面量的函数调用语法糖, 因此很容易可以实现这样的一个构造:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">w = Window&#123;x = <span class="number">0</span>, y = <span class="number">0</span>, width = <span class="number">300</span>, height = <span class="number">200</span>&#125;</span><br></pre></td></tr></table></figure>

<p>这是一种很好的设计, 具有较高的可读性。</p>
<h3 id="深入函数"><a href="#深入函数" class="headerlink" title="深入函数"></a>深入函数</h3><p>一种基本的语法糖:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span><span class="params">(x)</span></span> <span class="keyword">return</span> <span class="number">2</span>*x <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 等价写法</span></span><br><span class="line"></span><br><span class="line">foo = <span class="function"><span class="keyword">function</span><span class="params">(x)</span></span> <span class="keyword">return</span> <span class="number">2</span>*x <span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>可以认为function函数声明就是一个构造式, 这种无名的构造可以认为是匿名函数。下面利用了匿名函数来实现排序:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">a = &#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">56</span>,<span class="number">1</span>,<span class="number">-2</span>,<span class="number">3</span>,<span class="number">-8</span>&#125;</span><br><span class="line"><span class="built_in">table</span>.<span class="built_in">sort</span>(a, <span class="function"><span class="keyword">function</span><span class="params">(a,b)</span></span> <span class="keyword">return</span> (a&gt;b) <span class="keyword">end</span>)</span><br><span class="line"><span class="keyword">for</span> k,v <span class="keyword">in</span> <span class="built_in">ipairs</span>(a) <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">print</span>(v)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- output: 排序结果</span></span><br></pre></td></tr></table></figure>

<p>匿名函数的高级应用, 求导:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">derivative</span><span class="params">(f, delta)</span></span></span><br><span class="line">    delta = delta <span class="keyword">or</span> <span class="number">1e-4</span></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span><span class="params">(x)</span></span></span><br><span class="line">        <span class="keyword">return</span> (f(x + delta)-f(x))/delta</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">c = derivative(<span class="built_in">math</span>.<span class="built_in">sin</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">math</span>.<span class="built_in">cos</span>(<span class="number">10</span>), c(<span class="number">10</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">-- output: -0.83907152907645       -0.83904432662041</span></span><br></pre></td></tr></table></figure>

<p>此处的原理就是f在x的导数就是<code>(f(x+delta)-f(x))/delta</code>, 其中delta趋近于0。</p>
<p>这里利用的技巧就是, <code>delta</code>传入的值为nil时, <code>delta</code>为1e-4, 这个技巧很常用。</p>
<p>高级的东西, 函数闭包:</p>
<p>将一个函数写在另一个函数之内, 这个内部的函数能访问到外部函数的局部变量, 这叫做”词法域”, 下面是一个有用的例子:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 名字列表</span></span><br><span class="line">names = &#123;<span class="string">&quot;Peter&quot;</span>, <span class="string">&quot;Paul&quot;</span>, <span class="string">&quot;Mary&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 年级列表</span></span><br><span class="line">grades = &#123;Mary = <span class="number">10</span>, Paul = <span class="number">7</span>, Peter = <span class="number">8</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sortbygrade</span><span class="params">(names, grades)</span></span></span><br><span class="line">    <span class="built_in">table</span>.<span class="built_in">sort</span>(names, <span class="function"><span class="keyword">function</span><span class="params">(n1, n2)</span></span></span><br><span class="line">        <span class="keyword">return</span> grades[n1] &gt; grades[n2]</span><br><span class="line">    <span class="keyword">end</span> )</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">sortbygrade(names, grades)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 年级大的排在前面</span></span><br><span class="line"><span class="built_in">print</span>(names[<span class="number">1</span>], names[<span class="number">2</span>], names[<span class="number">3</span>])</span><br></pre></td></tr></table></figure>

<p>实现一个计数器:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">newCounter</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">        i = i + <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> i</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">counter = newCounter()</span><br><span class="line"><span class="built_in">print</span>(counter())</span><br><span class="line"><span class="built_in">print</span>(counter())</span><br><span class="line"><span class="built_in">print</span>(counter())</span><br><span class="line"></span><br><span class="line"><span class="comment">--[[ output:</span></span><br><span class="line"><span class="comment">1</span></span><br><span class="line"><span class="comment">2</span></span><br><span class="line"><span class="comment">3</span></span><br><span class="line"><span class="comment">--]]</span></span><br></pre></td></tr></table></figure>

<p>库函数的基本实现:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Lib = &#123;&#125;</span><br><span class="line"></span><br><span class="line">Lib.add = <span class="function"><span class="keyword">function</span><span class="params">(x,y)</span></span> <span class="keyword">return</span> x+y <span class="keyword">end</span></span><br><span class="line">Lib.<span class="built_in">sub</span> = <span class="function"><span class="keyword">function</span><span class="params">(x,y)</span></span> <span class="keyword">return</span> x-y <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 此外还有语法糖</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Lib.multipy</span><span class="params">(x,y)</span></span> <span class="keyword">return</span> x*y <span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>局部函数及其语法糖:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> f = <span class="function"><span class="keyword">function</span> <span class="title">f</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 下面是等价形式</span></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">f</span><span class="params">()</span></span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>递归的局部函数:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 错误, 闭包里面的fact其实代指的是全局函数</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="keyword">local</span> fact = <span class="function"><span class="keyword">function</span><span class="params">(n)</span></span></span><br><span class="line">    <span class="keyword">if</span> n == <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> n*fact(n<span class="number">-1</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 要解决这个问题可以这么做</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="keyword">local</span> fact</span><br><span class="line">fact = <span class="function"><span class="keyword">function</span><span class="params">(n)</span></span></span><br><span class="line">    <span class="keyword">if</span> n == <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> n*fact(n<span class="number">-1</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 对于间接进行的递归, 还是必须使用前向声明</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="keyword">local</span> f,g</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">g</span><span class="params">()</span></span></span><br><span class="line">    ...一些代码 f() 一些代码...</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 别忘了function f()是 f = function()的语法糖</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f</span><span class="params">()</span></span></span><br><span class="line">    ...一些代码 g() 一些代码...</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>语法糖的拓展:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 合法的</span></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">fact</span><span class="params">(n)</span></span></span><br><span class="line">    <span class="keyword">if</span> n == <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> n*fact(n<span class="number">-1</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 因为上面的代码被拓展为</span></span><br><span class="line"><span class="keyword">local</span> fact</span><br><span class="line">fact = ... <span class="comment">-- 此处省略</span></span><br></pre></td></tr></table></figure>

<p>尾调用消除:</p>
<p>TODO: 这个不影响编程, 是一个优化, 先搁置了。</p>
<h3 id="迭代器和泛型for"><a href="#迭代器和泛型for" class="headerlink" title="迭代器和泛型for"></a>迭代器和泛型for</h3><p>lua中, 迭代器就是一个函数, 每调用一次, 返回集合中下一个元素。迭代器的实现依赖”闭包”的特性。</p>
<p>一个简单的图景, 数值产生器:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">values</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span><span class="params">()</span></span> i = i+<span class="number">1</span>; <span class="keyword">return</span> i <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">iter = values()</span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">local</span> element = iter()</span><br><span class="line">    <span class="built_in">print</span>(element)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- output: 从1一直递增</span></span><br></pre></td></tr></table></figure>

<p>这个例子和前面闭包的例子很像, 不必多说。</p>
<p>与泛型for结合:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">values</span><span class="params">(t)</span></span></span><br><span class="line">    <span class="keyword">local</span> i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span><span class="params">()</span></span> i = i+<span class="number">1</span>; <span class="keyword">return</span> t[i] <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> element <span class="keyword">in</span> values(&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;) <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">print</span>(element)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p><code>values()</code>返回一个函数, 每次循环element都调用这个函数取得一个数值, 如果数值为nil, 那么就结束循环。</p>
<p>更好的例子, 扫描文件的所有单词:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>  <span class="title">allwords</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> line = <span class="built_in">io</span>.<span class="built_in">read</span>()</span><br><span class="line">    <span class="keyword">local</span> pos = <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">()</span></span></span><br><span class="line">        <span class="keyword">while</span> line <span class="keyword">do</span></span><br><span class="line">            <span class="keyword">local</span> s, e = <span class="built_in">string</span>.<span class="built_in">find</span>(line, <span class="string">&quot;%w+&quot;</span>, pos)</span><br><span class="line">            <span class="keyword">if</span> s <span class="keyword">then</span></span><br><span class="line">                pos = e + <span class="number">1</span></span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">string</span>.<span class="built_in">sub</span>(line, s, e)</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                line = <span class="built_in">io</span>.<span class="built_in">read</span>()</span><br><span class="line">                pos = <span class="number">1</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> word <span class="keyword">in</span> allwords() <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">print</span>(word)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 要运行这个例子用重定向: lua main.lua &lt; file</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- output: 一个单词一行</span></span><br></pre></td></tr></table></figure>

<p>泛型for的原理：</p>
<p>一个泛型for包含三个概念, 一个迭代器函数, 一个恒定状态, 一个控制变量, 下面通过例子说明:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a = &#123;<span class="string">&quot;one&quot;</span>, <span class="string">&quot;two&quot;</span>, <span class="string">&quot;three&quot;</span>&#125;</span><br><span class="line"><span class="keyword">for</span> i, v <span class="keyword">in</span> <span class="built_in">ipairs</span>(a) <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">print</span>(i, v)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p><code>ipairs(a)</code>返回三个东西, 第一个为迭代器函数, 第二个是控制变量初值, 第三个为恒定状态初值。这三个东西被for循环保存, 每次循环for都会调用迭代器函数, 返回上一次的控制变量和恒定状态。下面是基本用法和原理:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> &lt;var-list&gt; <span class="keyword">in</span> &lt;<span class="built_in">exp</span>-list&gt; <span class="keyword">do</span></span><br><span class="line">    &lt;body&gt;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>通常<code>&lt;exp-list&gt;</code>只包含一个元素, 多个元素用逗号分割, 这里不讨论多个元素的情况。</p>
<p>变量列表可以有多个变量, 其中第一个元素为控制变量, 在循环过程中决不会为nil, 当它为nil时, 循环结束, 这也是”控制”说法的由来。</p>
<p>等价形式:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> var_1, ... var_n <span class="keyword">in</span> &lt;explist&gt; <span class="keyword">do</span> &lt;block&gt; <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 等价于</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="keyword">local</span> _f, _s, _var = &lt;explist&gt;</span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">local</span> var_1, ..., var_n = _f(_s, _var)</span><br><span class="line">    _var = var_1</span><br><span class="line">    <span class="keyword">if</span> _var == <span class="literal">nil</span> <span class="keyword">then</span> <span class="keyword">break</span> <span class="keyword">end</span></span><br><span class="line">    &lt;block&gt;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>下面展示一种较为奇葩的情况:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">test</span><span class="params">()</span></span></span><br><span class="line">    a = a + <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> a == <span class="number">6</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> a</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> element <span class="keyword">in</span> test <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">print</span>(element)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--[[ output:</span></span><br><span class="line"><span class="comment">1</span></span><br><span class="line"><span class="comment">2</span></span><br><span class="line"><span class="comment">3</span></span><br><span class="line"><span class="comment">4</span></span><br><span class="line"><span class="comment">5</span></span><br><span class="line"><span class="comment">--]]</span></span><br></pre></td></tr></table></figure>

<p>如果<explist>里面少于三个元素, 那么其余补nil, 因此第一个循环时, element &#x3D; 1, 第二次循环时, 调用test(nil, nil), 拿到element &#x3D; 2, 以此类推。</p>
<p>实现ipairs:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myipairs</span><span class="params">(t)</span></span></span><br><span class="line">    <span class="keyword">local</span> i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">()</span></span></span><br><span class="line">        i = i + <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> t[i] == <span class="literal">nil</span> <span class="keyword">then</span> <span class="keyword">return</span> <span class="literal">nil</span> <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">return</span> i, t[i]</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">a = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> index, value <span class="keyword">in</span> myipairs(a) <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">print</span>(index, value)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>实现pairs:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mypairs</span><span class="params">(tbl)</span></span></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span><span class="params">(state, control)</span></span> <span class="comment">-- iterator</span></span><br><span class="line">        control = <span class="built_in">next</span>(tbl, control)</span><br><span class="line">        <span class="keyword">local</span> value = tbl[control]</span><br><span class="line">        <span class="keyword">return</span> control, value</span><br><span class="line">    <span class="keyword">end</span>, <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="literal">nil</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> tb = &#123;aa = <span class="string">&quot;bb&quot;</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;</span><br><span class="line"><span class="keyword">for</span> key, value <span class="keyword">in</span> mypairs(tb) <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">print</span>(key, value)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>pairs迭代依赖了next, 这个可以拿到下一个键名, 这个是黑科技?(TODO: 怎么做next?)</p>
<p>下面进行一个实现, 证明对设置某个对应的键的值为nil, 就相当于删除了这个键值对, next都拿不到啊:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mySelectLength</span><span class="params">(t)</span></span></span><br><span class="line">    <span class="keyword">local</span> ret = <span class="number">0</span></span><br><span class="line">    <span class="keyword">local</span> last = <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">        last = <span class="built_in">next</span>(t, last)</span><br><span class="line">        <span class="keyword">if</span> last == <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span> ret</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        ret = ret + <span class="number">1</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myJingHao</span><span class="params">(t)</span></span></span><br><span class="line">    <span class="keyword">local</span> idx = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">if</span> t[idx+<span class="number">1</span>] == <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span> idx</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        idx = idx + <span class="number">1</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">testSelect</span><span class="params">(...)</span></span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">select</span>(<span class="string">&#x27;#&#x27;</span>, ...)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- output: 7, 6, 3</span></span><br><span class="line"><span class="built_in">print</span>(testSelect(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="literal">nil</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>))</span><br><span class="line"><span class="built_in">print</span>(mySelectLength(&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="literal">nil</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>&#125;))</span><br><span class="line"><span class="built_in">print</span>(myJingHao(&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="literal">nil</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>&#125;))</span><br></pre></td></tr></table></figure>

<p>那么<code>select(&#39;#&#39;,...)</code>是咋实现的呢?下面给个思路:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mySelectReally</span><span class="params">(...)</span></span></span><br><span class="line">    <span class="keyword">local</span> t = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">pairs</span>(&#123;...&#125;) <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">type</span>(v) == <span class="string">&quot;number&quot;</span> <span class="keyword">and</span> v &gt; t <span class="keyword">then</span></span><br><span class="line">            t = k</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> t</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(mySelectReally(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="literal">nil</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">-- output: 7</span></span><br></pre></td></tr></table></figure>

<h3 id="编译执行和错误"><a href="#编译执行和错误" class="headerlink" title="编译执行和错误"></a>编译执行和错误</h3><p>TODO</p>
<h3 id="协程"><a href="#协程" class="headerlink" title="协程"></a>协程</h3><p>关于协程的函数放在名为”coroutine”的table中(别忘了lua靠table实现模块)。create用来创建一个协程：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">co = <span class="built_in">coroutine</span>.<span class="built_in">create</span>(<span class="function"><span class="keyword">function</span> <span class="params">()</span></span> <span class="built_in">print</span>(<span class="string">&quot;hi&quot;</span>) <span class="keyword">end</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(co) <span class="comment">--&gt; thread: 0x...</span></span><br></pre></td></tr></table></figure>

<p>协程的四种状态:</p>
<ul>
<li>挂起: suspended</li>
<li>运行: running</li>
<li>死亡: dead</li>
<li>正常: normal</li>
</ul>
<p>通过<code>coroutine.status(co)</code>来检查协程的状态:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="built_in">coroutine</span>.<span class="built_in">status</span>(co)) <span class="comment">--&gt; suspended</span></span><br></pre></td></tr></table></figure>

<p>函数<code>coroutine.resume(co)</code>用于启动一个协程的执行, 此时协程的状态变成运行。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">coroutine</span>.<span class="built_in">resume</span>(co) <span class="comment">--&gt; hi</span></span><br></pre></td></tr></table></figure>

<p>打印后, 协程有运行状态变为死亡状态:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="built_in">coroutine</span>.<span class="built_in">status</span>(co)) <span class="comment">--&gt; dead</span></span><br></pre></td></tr></table></figure>

<p>协程允许主动让出执行权, 下面是一个全面的例子:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">co = <span class="built_in">coroutine</span>.<span class="built_in">create</span>(<span class="function"><span class="keyword">function</span> <span class="params">()</span></span></span><br><span class="line">    <span class="keyword">for</span> i = <span class="number">1</span>,<span class="number">10</span> <span class="keyword">do</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;co&quot;</span>, i)</span><br><span class="line">        <span class="built_in">coroutine</span>.<span class="built_in">yield</span>()</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">coroutine</span>.<span class="built_in">resume</span>(co)</span><br><span class="line"><span class="built_in">coroutine</span>.<span class="built_in">resume</span>(co)</span><br><span class="line"><span class="built_in">coroutine</span>.<span class="built_in">resume</span>(co)</span><br><span class="line"><span class="built_in">coroutine</span>.<span class="built_in">resume</span>(co)</span><br><span class="line"></span><br><span class="line"><span class="comment">--[[</span></span><br><span class="line"><span class="comment">co      1</span></span><br><span class="line"><span class="comment">co      2</span></span><br><span class="line"><span class="comment">co      3</span></span><br><span class="line"><span class="comment">co      4</span></span><br><span class="line"><span class="comment">--]]</span></span><br></pre></td></tr></table></figure>

<p>resume-yield的消息传递机制:</p>
<p>可以通过一对resume-yield来交换数据, 特别的是, 第一次调用resume时, 没有yield在等待它, 那么数据被放入协程函数的参数列表中, 下面是一个例子:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">co = <span class="built_in">coroutine</span>.<span class="built_in">create</span>(<span class="function"><span class="keyword">function</span> <span class="params">(a,b,c)</span></span></span><br><span class="line">    <span class="built_in">print</span>(a, b, c)</span><br><span class="line"><span class="keyword">end</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">coroutine</span>.<span class="built_in">resume</span>(co, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- output: 1    2   3</span></span><br></pre></td></tr></table></figure>

<p>一个更好的例子, 用来做数值产生器:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">co = <span class="built_in">coroutine</span>.<span class="built_in">create</span>(<span class="function"><span class="keyword">function</span> <span class="params">(...)</span></span></span><br><span class="line">    <span class="keyword">local</span> <span class="built_in">next</span> = &#123;...&#125;</span><br><span class="line">    <span class="keyword">local</span> sum  = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">        sum = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">pairs</span>(<span class="built_in">next</span>) <span class="keyword">do</span></span><br><span class="line">            sum = sum + v</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="built_in">next</span> = &#123;<span class="built_in">coroutine</span>.<span class="built_in">yield</span>(sum)&#125;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">coroutine</span>.<span class="built_in">resume</span>(co, <span class="number">5</span>, <span class="number">3</span>, <span class="number">2</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">coroutine</span>.<span class="built_in">resume</span>(co, <span class="number">5</span>, <span class="number">3</span>, <span class="number">1</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">--[[ output:</span></span><br><span class="line"><span class="comment">true    10</span></span><br><span class="line"><span class="comment">true    9</span></span><br><span class="line"><span class="comment">--]]</span></span><br></pre></td></tr></table></figure>

<p>resume的返回值中, 第一个值为true表示没有错误, 后面都是yield返回的对象。</p>
<p>当一个协程结束时, 它的函数返回值作为对应resume的返回值。</p>
<p>lua协程的概述:</p>
<p>与go的不同, lua的协程被称为”非对称的协同程序”。它是非抢占式的, 协程必须自发挂起。lua的协程在任意时刻只有一个协程在运行, 我认为这就无疑像单线程了, 因为一个协程启动了另外一个协程, 自己此时就被阻塞在那了, 只是换了另外一个协程来执行, 整体来说还是单个协程在执行。</p>
<p>如果要多线程下载文件, 简述下面的方法:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">download</span><span class="params">(host, file)</span></span></span><br><span class="line">    <span class="keyword">local</span> c = <span class="built_in">assert</span>(socket.connect(host,<span class="number">80</span>))</span><br><span class="line">    <span class="keyword">local</span> cout = <span class="number">0</span></span><br><span class="line">    c:send(<span class="string">&quot;GET &quot;</span> .. file .. <span class="string">&quot; HTTP/1.0\r\n\r\n&quot;</span>)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> s, <span class="built_in">status</span>, partial = receive(c)</span><br><span class="line">        count = count + #(s <span class="keyword">or</span> partial)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">status</span> = <span class="string">&quot;closed&quot;</span> <span class="keyword">then</span> <span class="keyword">break</span> <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    c:<span class="built_in">close</span>()</span><br><span class="line">    <span class="built_in">print</span>(file, count)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">receive</span><span class="params">(connection)</span></span></span><br><span class="line">    connection:settimeout(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">local</span> s, <span class="built_in">status</span>, partial = connection:receive(<span class="number">2</span>^<span class="number">10</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">status</span> == <span class="string">&quot;timeout&quot;</span> <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">coroutine</span>.<span class="built_in">yield</span>(connection)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> s <span class="keyword">or</span> partial, <span class="built_in">status</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>这里的技巧是, 将IO设置为非阻塞的, 然后没有事件就立马返回。把时间留给有IO的协程。</p>
<p>TODO: 所以我觉得这就像随时切换执行流的单线程程序, 我的认知有误吗?</p>
<h3 id=""><a href="#" class="headerlink" title=""></a></h3>
    
  </div>
  <footer>
    
      
      
  <div class="tags">
    <a class="tags-none-link" href="/tags/lua/" rel="tag">lua</a>, <a class="tags-none-link" href="/tags/notes/" rel="tag">notes</a>
  </div>

    
    <div class="clearfix"></div>
  </footer>
</article>

</div>
  </div>
  <footer id="footer"><div class="copyright">
  
  &copy; 2023 <a href="/">Markity</a>
  
</div>
<div class="theme-copyright">
  Theme by <a href="https://github.com/orderedlist" target="_blank">orderedlist</a>
   | 
  Redesign by <a href="http://heroicyang.com/" target="_blank">Heroic Yang</a>
</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
<script src="/js/scale.fix.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
  (function($){
    $('.fancybox').fancybox();
  })(jQuery);
</script>

</body>
</html>